<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kas Masjid Jami' Daarul Muttaqin Bulusari</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Menambahkan gambar latar belakang untuk top-card */
    .top-card {
      background-image: url('https://raw.githubusercontent.com/akbarromadon34-beep/laporan-kas-masjid/refs/heads/main/masjid.png'); /* URL gambar yang diupload */
      background-size: cover; /* Menyusun gambar agar menutupi seluruh area */
      background-position: center; /* Menjaga gambar tetap terpusat */
      background-repeat: no-repeat; /* Agar gambar tidak diulang */
      border-radius: 10px; /* Membuat sudut card melengkung */
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Menambahkan bayangan lembut */
      padding: 20px; /* Memberikan jarak dalam card */
      margin-bottom: 30px; /* Memberikan jarak bawah pada card */
      color: white; /* Membuat teks putih agar terbaca di atas gambar */
      position: relative; /* Menyusun posisi layer dengan benar */
    }

    /* Menambahkan layer transparan di seluruh area */
    .top-card::before {
      content: ""; /* Membuat layer baru */
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.6); /* Box putih dengan transparansi 60% */
      border-radius: 10px;
      z-index: -1; /* Membuat layer berada di bawah semua konten */
    }

    /* Membuat teks tetap berada di atas layer transparan */
    .title-card, .bismillah-text {
      position: relative; /* Menjaga posisi teks tetap di atas */
      z-index: 1; /* Membuat teks tetap berada di atas layer */
      font-weight: bold; /* Teks tebal */
      color: #000000; /* Teks hitam */
    }

    .top-controls {
      position: relative; /* Menjaga posisi input dan tombol tetap di atas */
      z-index: 1; /* Membuat input dan tombol tetap di atas layer */
    }

    /* Styling untuk tombol dengan kategori warna dan teks putih tebal */
    .btn-outline-secondary {
      background-color: #6c757d; /* Warna abu-abu untuk Reset */
      color: white;
      font-weight: bold;
    }

    .btn-outline-primary {
      background-color: #007bff; /* Warna biru untuk Refresh */
      color: white;
      font-weight: bold;
    }

    .btn-outline-success {
      background-color: #28a745; /* Warna hijau untuk Download Laporan */
      color: white;
      font-weight: bold;
    }

    .card-total-masuk {
      background-color: #28a745; /* Hijau */
      color: white;
    }

    .card-total-keluar {
      background-color: #dc3545; /* Merah */
      color: white;
    }

    .card-saldo {
      background-color: #007bff; /* Biru */
      color: white;
    }

    .card-header {
      text-align: center;
    }

    .container {
      padding-top: 30px;
      padding-bottom: 30px;
    }

    .alert {
      margin-top: 20px;
    }

    .table th, .table td {
      text-align: left;
    }

    .table th:nth-child(1), .table td:nth-child(1) {
      width: 120px;
      padding-right: 15px;
    }

    .table th:nth-child(2), .table td:nth-child(2) {
      width: 100px;
    }

    .table th:nth-child(3), .table td:nth-child(3) {
      width: 150px;
    }

    .table th:nth-child(4), .table td:nth-child(4) {
      width: 200px;
    }

    .table th:nth-child(5), .table td:nth-child(5) {
      width: 140px;
      padding-left: 15px;
    }

    .bismillah-text {
      font-size: 3rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 20px;
      font-family: 'Traditional Arabic', sans-serif;
      color: #000000;
    }

    .top-card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 30px;
    }

    .table-card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }

    .top-controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }

    .top-controls .form-control {
      width: 200px;
    }

    .title-card {
      text-align: center;
      font-weight: bold;
      font-size: 2rem;
      margin-top: 20px;
    }

    /* Media Query untuk responsif di perangkat mobile */
    @media (max-width: 768px) {
      .container {
        padding-top: 15px;
        padding-bottom: 15px;
      }

      /* Menyesuaikan ukuran teks */
      .bismillah-text {
        font-size: 2rem;
      }

      .title-card {
        font-size: 1.5rem;
      }

      /* Menyesuaikan ukuran dan tata letak tombol */
      .top-controls {
        flex-direction: column;
        align-items: center;
      }

      .top-controls .form-control {
        width: 100%; /* Membuat input bulan lebih lebar pada perangkat kecil */
        margin-bottom: 10px;
      }

      .btn-outline-secondary,
      .btn-outline-primary,
      .btn-outline-success {
        width: 100%; /* Membuat tombol mengambil seluruh lebar */
        margin-bottom: 10px;
      }

      /* Menyesuaikan card agar lebih rapi pada perangkat kecil */
      .card {
        margin-bottom: 15px;
      }

      .card-total-masuk, .card-total-keluar, .card-saldo {
        text-align: center;
        margin-bottom: 10px;
      }

      /* Mengubah tabel menjadi lebih responsif */
      .table th, .table td {
        font-size: 0.875rem; /* Mengurangi ukuran font pada perangkat kecil */
        padding: 8px;
      }

      .table th:nth-child(1), .table td:nth-child(1),
      .table th:nth-child(2), .table td:nth-child(2),
      .table th:nth-child(3), .table td:nth-child(3),
      .table th:nth-child(4), .table td:nth-child(4),
      .table th:nth-child(5), .table td:nth-child(5) {
        width: auto; /* Membuat kolom lebih fleksibel */
      }
    }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">

  <!-- Menambahkan card putih untuk bagian atas dengan judul dan tombol -->
  <div class="top-card">
    <!-- Menambahkan tulisan Bismillah di atas -->
    <div class="bismillah-text">
      بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ
    </div>

    <!-- Menambahkan tulisan judul di bawah Bismillah dan memusatkannya -->
    <div class="title-card">
      Kas Masjid Jami' Daarul Muttaqin Bulusari
    </div>

    <!-- Membungkus tombol dan input bulan dalam div dengan class "top-controls" -->
    <div class="top-controls">
      <input id="filterBulan" class="form-control" type="month" />
      <button id="btnReset" class="btn btn-outline-secondary">Reset</button>
      <button id="btnRefresh" class="btn btn-outline-primary">Refresh</button>
      <button id="btnDownload" class="btn btn-outline-success">Download Laporan</button>
    </div>
  </div>

  <div id="alert" class="alert alert-danger d-none"></div>

  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card shadow-sm card-total-masuk">
        <div class="card-body">
          <div class="text-muted">Total Masuk</div>
          <div id="totalMasuk" class="fs-4 fw-semibold">Rp 0</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm card-total-keluar">
        <div class="card-body">
          <div class="text-muted">Total Keluar</div>
          <div id="totalKeluar" class="fs-4 fw-semibold">Rp 0</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm card-saldo">
        <div class="card-body">
          <div class="text-muted">Saldo</div>
          <div id="saldo" class="fs-4 fw-semibold">Rp 0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Membungkus tabel dengan card putih -->
  <div class="table-card">
    <div class="card shadow-sm">
      <div class="card-header fw-semibold">Riwayat Transaksi</div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th>Tanggal</th>
                <th>Tipe</th>
                <th>Kategori</th>
                <th>Keterangan</th>
                <th class="text-end">Jumlah</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="5" class="text-center text-muted py-4">Memuat data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <p class="text-muted mt-3 mb-0 small">
    Auto-refresh tiap 60 detik. 
  </p>

</div>

<script>
  // GANTI INI
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzkZE04KqraseX0pGSARSmdKxK_70QD85FgGJWSdmNO9JDnDI3WBnuyLyBLILVioxzZ/exec";

  const el = (id) => document.getElementById(id);
  const rupiah = (n) => "Rp " + (n || 0).toLocaleString("id-ID");

  // Fungsi untuk format tanggal menjadi "1 Januari 2025"
  function formatTanggal(tanggal) {
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return new Date(tanggal).toLocaleDateString('id-ID', options);
  }

  function showError(msg) {
    el("alert").textContent = msg;
    el("alert").classList.remove("d-none");
  }
  function hideError() {
    el("alert").classList.add("d-none");
    el("alert").textContent = "";
  }

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function badgeTipe(tipe) {
    const t = String(tipe || "").toUpperCase();
    if (t === "MASUK") return `<span class="badge text-bg-success">MASUK</span>`;
    if (t === "KELUAR") return `<span class="badge text-bg-danger">KELUAR</span>`;
    return `<span class="badge text-bg-secondary">${escapeHtml(t || "-")}</span>`;
  }

  function getFilterBulan() {
    const v = (el("filterBulan").value || "").trim();
    return /^\d{4}-\d{2}$/.test(v) ? v : "";
  }

  // JSONP helper (bypass CORS)
  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(16).slice(2);
      const script = document.createElement("script");
      const sep = url.includes("?") ? "&" : "?";
      const full = `${url}${sep}callback=${cb}&_=${Date.now()}`;

      window[cb] = (payload) => {
        cleanup();
        resolve(payload);
      };

      script.onerror = () => {
        cleanup();
        reject(new Error("Gagal load JSONP"));
      };

      function cleanup() {
        delete window[cb];
        script.remove();
      }

      script.src = full;
      document.body.appendChild(script);
    });
  }

  let lastData = [];

  function render(data) {
    const bulan = getFilterBulan();
    const filtered = bulan
      ? data.filter(x => String(x.tgl || "").slice(0, 7) === bulan)
      : data.slice();

    // Mengurutkan data berdasarkan tanggal (dari yang terlama ke yang terbaru)
    filtered.sort((a, b) => new Date(a.tgl) - new Date(b.tgl));

    let masuk = 0, keluar = 0;
    for (const t of filtered) {
      const j = Number(t.jumlah) || 0;
      if (t.tipe === "MASUK") masuk += j;
      if (t.tipe === "KELUAR") keluar += j;
    }

    el("totalMasuk").textContent = rupiah(masuk);
    el("totalKeluar").textContent = rupiah(keluar);
    el("saldo").textContent = rupiah(masuk - keluar);

    const tb = el("tbody");
    tb.innerHTML = "";

    if (filtered.length === 0) {
      tb.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">Tidak ada data.</td></tr>`;
      return;
    }

    for (const t of filtered) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${formatTanggal(t.tgl || "")}</td> <!-- Mengubah format tanggal -->
        <td>${badgeTipe(t.tipe)}</td>
        <td>${escapeHtml(t.kategori || "")}</td>
        <td>${escapeHtml(t.keterangan || "")}</td>
        <td class="text-end">${rupiah(Number(t.jumlah) || 0)}</td>
      `;
      tb.appendChild(tr);
    }
  }

  async function refresh() {
    hideError();
    try {
      const res = await jsonp(`${WEB_APP_URL}?action=getTransactions`);
      if (!res || !res.ok) throw new Error(res?.error || "Response tidak valid");
      lastData = Array.isArray(res.data) ? res.data : [];
      render(lastData);
    } catch (e) {
      showError("Gagal ambil data: " + (e?.message || String(e)));
      el("tbody").innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">Gagal memuat data.</td></tr>`;
    }
  }

  // Fungsi untuk mendownload laporan dalam format PDF
  function downloadLaporan() {
    const { jsPDF } = window.jspdf;  // Mengambil jsPDF dari pustaka
    const doc = new jsPDF();

    // Menambahkan judul laporan
    doc.setFontSize(18);
    doc.text("Laporan Transaksi Kas Masjid Daarul Muttaqin Bulusari", 14, 20);
    doc.setFontSize(12);
    doc.text(`Tanggal: ${new Date().toLocaleDateString()}`, 14, 30);
    doc.text(`Waktu: ${new Date().toLocaleTimeString()}`, 14, 35);

    // Menambahkan header tabel
    const headers = ['Tanggal', 'Tipe', 'Kategori', 'Keterangan', 'Jumlah'];
    let startY = 45; // Mulai menulis tabel dari Y = 45
    headers.forEach((header, index) => {
      doc.text(header, 14 + index * 40, startY);
    });

    // Filter hanya transaksi "MASUK" dan "KELUAR"
    const filteredData = lastData.filter(transaction => transaction.tipe === "MASUK" || transaction.tipe === "KELUAR");

    // Mengurutkan transaksi berdasarkan tanggal (dari yang terlama ke yang terbaru)
    filteredData.sort((a, b) => new Date(a.tgl) - new Date(b.tgl));

    // Menambahkan data transaksi ke dalam PDF
    startY += 10;
    filteredData.forEach(transaction => {
      if (startY > 250) {  // Jika sudah melewati batas halaman
        doc.addPage(); // Menambahkan halaman baru
        startY = 20; // Reset posisi Y untuk halaman baru
        // Menambahkan header lagi di halaman baru
        headers.forEach((header, index) => {
          doc.text(header, 14 + index * 40, startY);
        });
        startY += 10;  // Memberikan jarak setelah header
      }

      doc.text(formatTanggal(transaction.tgl), 14, startY);  // Menggunakan format tanggal
      doc.text(transaction.tipe, 54, startY);
      doc.text(transaction.kategori || '', 94, startY);
      doc.text(transaction.keterangan || '', 134, startY);
      doc.text(rupiah(Number(transaction.jumlah) || 0), 174, startY);
      startY += 7; // Menambah jarak antar baris
    });

    // Menyimpan PDF
    doc.save("laporan_transaksi.pdf");
  }

  el("filterBulan").addEventListener("change", () => render(lastData));
  el("btnReset").addEventListener("click", () => { el("filterBulan").value = ""; render(lastData); });
  el("btnRefresh").addEventListener("click", refresh);
  el("btnDownload").addEventListener("click", downloadLaporan);  // Event untuk tombol Download Laporan

  refresh();
  setInterval(refresh, 60000); // auto update tiap 60 detik
</script>
</body>
</html>
