<?php
declare(strict_types=1);

// ============================
// Konfigurasi
// ============================
date_default_timezone_set('Asia/Jakarta');
$dbFile = __DIR__ . '/kas.sqlite';

// ============================
// Inisialisasi DB (SQLite)
// ============================
$db = new SQLite3($dbFile);
$db->exec('PRAGMA foreign_keys = ON;');
$db->exec('
CREATE TABLE IF NOT EXISTS transactions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  tgl TEXT NOT NULL,
  tipe TEXT NOT NULL CHECK (tipe IN ("MASUK","KELUAR")),
  kategori TEXT NOT NULL,
  keterangan TEXT,
  jumlah INTEGER NOT NULL CHECK (jumlah > 0),
  dibuat_pada TEXT NOT NULL
);
');

function h(string $s): string { return htmlspecialchars($s, ENT_QUOTES, 'UTF-8'); }
function rupiah(int $n): string { return 'Rp ' . number_format($n, 0, ',', '.'); }

// ============================
// Handle aksi: tambah / hapus
// ============================
$err = '';
if ($_SERVER['REQUEST_METHOD'] === 'POST' && ($_POST['aksi'] ?? '') === 'tambah') {
  $tgl = trim((string)($_POST['tgl'] ?? ''));
  $tipe = strtoupper(trim((string)($_POST['tipe'] ?? '')));
  $kategori = trim((string)($_POST['kategori'] ?? ''));
  $keterangan = trim((string)($_POST['keterangan'] ?? ''));
  $jumlah = (int)($_POST['jumlah'] ?? 0);

  if ($tgl === '' || !preg_match('/^\d{4}-\d{2}-\d{2}$/', $tgl)) $err = 'Tanggal tidak valid.';
  elseif (!in_array($tipe, ['MASUK','KELUAR'], true)) $err = 'Tipe harus MASUK atau KELUAR.';
  elseif ($kategori === '') $err = 'Kategori wajib diisi.';
  elseif ($jumlah <= 0) $err = 'Jumlah harus > 0.';

  if ($err === '') {
    $stmt = $db->prepare('
      INSERT INTO transactions (tgl, tipe, kategori, keterangan, jumlah, dibuat_pada)
      VALUES (:tgl, :tipe, :kategori, :keterangan, :jumlah, :dibuat_pada)
    ');
    $stmt->bindValue(':tgl', $tgl, SQLITE3_TEXT);
    $stmt->bindValue(':tipe', $tipe, SQLITE3_TEXT);
    $stmt->bindValue(':kategori', $kategori, SQLITE3_TEXT);
    $stmt->bindValue(':keterangan', $keterangan, SQLITE3_TEXT);
    $stmt->bindValue(':jumlah', $jumlah, SQLITE3_INTEGER);
    $stmt->bindValue(':dibuat_pada', date('c'), SQLITE3_TEXT);
    $stmt->execute();

    header('Location: ' . strtok($_SERVER['REQUEST_URI'], '?'));
    exit;
  }
}

if (isset($_GET['hapus'])) {
  $id = (int)$_GET['hapus'];
  if ($id > 0) {
    $stmt = $db->prepare('DELETE FROM transactions WHERE id = :id');
    $stmt->bindValue(':id', $id, SQLITE3_INTEGER);
    $stmt->execute();
  }
  header('Location: ' . strtok($_SERVER['REQUEST_URI'], '?'));
  exit;
}

// ============================
// Filter sederhana (bulan)
// ============================
$bulan = trim((string)($_GET['bulan'] ?? '')); // format YYYY-MM
$where = '';
$params = [];
if ($bulan !== '' && preg_match('/^\d{4}-\d{2}$/', $bulan)) {
  $where = 'WHERE substr(tgl, 1, 7) = :bulan';
  $params[':bulan'] = $bulan;
}

// ============================
// Ambil data + ringkasan
// ============================
$sumMasuk = 0; $sumKeluar = 0;
$qSum = $db->prepare("
  SELECT
    COALESCE(SUM(CASE WHEN tipe='MASUK' THEN jumlah END), 0) AS masuk,
    COALESCE(SUM(CASE WHEN tipe='KELUAR' THEN jumlah END), 0) AS keluar
  FROM transactions
  $where
");
foreach ($params as $k => $v) $qSum->bindValue($k, $v, SQLITE3_TEXT);
$resSum = $qSum->execute()->fetchArray(SQLITE3_ASSOC);
$sumMasuk = (int)$resSum['masuk'];
$sumKeluar = (int)$resSum['keluar'];
$saldo = $sumMasuk - $sumKeluar;

$qList = $db->prepare("
  SELECT id, tgl, tipe, kategori, keterangan, jumlah
  FROM transactions
  $where
  ORDER BY tgl DESC, id DESC
");
foreach ($params as $k => $v) $qList->bindValue($k, $v, SQLITE3_TEXT);
$resList = $qList->execute();

// default tanggal hari ini
$defaultTgl = date('Y-m-d');
?>
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kas Masjid - Sederhana</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="m-0">Kas Masjid (Sederhana)</h3>
    <form class="d-flex gap-2" method="get">
      <input class="form-control" type="month" name="bulan" value="<?= h($bulan) ?>">
      <button class="btn btn-outline-primary" type="submit">Filter</button>
      <a class="btn btn-outline-secondary" href="<?= h(strtok($_SERVER['REQUEST_URI'], '?')) ?>">Reset</a>
    </form>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted">Total Masuk</div>
          <div class="fs-4 fw-semibold"><?= rupiah($sumMasuk) ?></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted">Total Keluar</div>
          <div class="fs-4 fw-semibold"><?= rupiah($sumKeluar) ?></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted">Saldo</div>
          <div class="fs-4 fw-semibold"><?= rupiah($saldo) ?></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-header fw-semibold">Tambah Transaksi</div>
    <div class="card-body">
      <?php if ($err !== ''): ?>
        <div class="alert alert-danger"><?= h($err) ?></div>
      <?php endif; ?>
      <form method="post" class="row g-3">
        <input type="hidden" name="aksi" value="tambah">
        <div class="col-md-2">
          <label class="form-label">Tanggal</label>
          <input class="form-control" type="date" name="tgl" value="<?= h($defaultTgl) ?>" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Tipe</label>
          <select class="form-select" name="tipe" required>
            <option value="MASUK">MASUK</option>
            <option value="KELUAR">KELUAR</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Kategori</label>
          <input class="form-control" name="kategori" placeholder="Contoh: Infak / Listrik" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Keterangan</label>
          <input class="form-control" name="keterangan" placeholder="Opsional">
        </div>
        <div class="col-md-2">
          <label class="form-label">Jumlah (Rp)</label>
          <input class="form-control" type="number" name="jumlah" min="1" step="1" required>
        </div>
        <div class="col-12">
          <button class="btn btn-primary" type="submit">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header fw-semibold">Riwayat Transaksi <?= $bulan ? '(Bulan: ' . h($bulan) . ')' : '' ?></div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th style="width:120px;">Tanggal</th>
              <th style="width:90px;">Tipe</th>
              <th style="width:180px;">Kategori</th>
              <th>Keterangan</th>
              <th class="text-end" style="width:140px;">Jumlah</th>
              <th class="text-end" style="width:90px;">Aksi</th>
            </tr>
          </thead>
          <tbody>
            <?php
              $ada = false;
              while ($row = $resList->fetchArray(SQLITE3_ASSOC)):
                $ada = true;
            ?>
              <tr>
                <td><?= h($row['tgl']) ?></td>
                <td>
                  <?php if ($row['tipe'] === 'MASUK'): ?>
                    <span class="badge text-bg-success">MASUK</span>
                  <?php else: ?>
                    <span class="badge text-bg-danger">KELUAR</span>
                  <?php endif; ?>
                </td>
                <td><?= h($row['kategori']) ?></td>
                <td><?= h((string)$row['keterangan']) ?></td>
                <td class="text-end"><?= rupiah((int)$row['jumlah']) ?></td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-danger"
                     onclick="return confirm('Hapus transaksi ini?')"
                     href="?hapus=<?= (int)$row['id'] ?><?= $bulan ? '&bulan=' . urlencode($bulan) : '' ?>">
                    Hapus
                  </a>
                </td>
              </tr>
            <?php endwhile; ?>
            <?php if (!$ada): ?>
              <tr><td colspan="6" class="text-center text-muted py-4">Belum ada transaksi.</td></tr>
            <?php endif; ?>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <p class="text-muted mt-3 mb-0 small">
    Tips: file database <code>kas.sqlite</code> ada di folder ini. Backup tinggal copy file itu.
  </p>

</div>
</body>
</html>
