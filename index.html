<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Informasi & Laporan Kas Masjid</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome & Google Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- jsPDF & AutoTable untuk Export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Konfigurasi Tailwind & Custom Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Amiri', 'serif'],
                    },
                    colors: {
                        emerald: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            600: '#059669',
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                        },
                        blue: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .islamic-pattern {
            background-color: #f8fafc;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231e40af' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* Blue loader */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for table on mobile */
        .table-container::-webkit-scrollbar {
            height: 6px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        .select-icon-wrapper {
            pointer-events: none;
            position: absolute;
            inset-y: 0;
            right: 0;
            display: flex;
            align-items: center;
            padding-right: 0.75rem;
        }
    </style>
</head>
<body class="islamic-pattern text-slate-800 antialiased min-h-screen flex flex-col">

    <!-- Notifikasi Toast -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 pointer-events-none"></div>

    <!-- Header / Navbar -->
    <nav class="bg-gradient-to-r from-blue-900 to-blue-800 text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center space-x-3">
                    <div class="bg-white p-1.5 rounded-full shadow-md">
                        <i class="fas fa-mosque text-blue-800 text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-serif text-xl font-bold tracking-wide leading-none">Masjid Jami' Daarul Muttaqin</h1>
                        <p class="text-[10px] text-blue-100 uppercase tracking-wider hidden sm:block mt-1">Transparansi Keuangan</p>
                    </div>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <button onclick="app.navigate('dashboard')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700/50 transition-all bg-blue-700 shadow-sm" data-target="dashboard">Dashboard</button>
                        <button onclick="app.navigate('portofolio')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700/50 transition-all text-blue-100" data-target="portofolio">Kegiatan</button>
                        <button onclick="app.navigate('kritik')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700/50 transition-all text-blue-100" data-target="kritik">Kritik & Saran</button>
                    </div>
                </div>

                <!-- Mobile Menu Button -->
                <div class="-mr-2 flex md:hidden">
                    <button onclick="app.toggleMobileMenu()" class="bg-blue-800 inline-flex items-center justify-center p-2 rounded-md text-blue-100 hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-blue-800 focus:ring-white">
                        <i class="fas fa-bars text-lg"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu Panel -->
        <div id="mobile-menu" class="hidden md:hidden bg-blue-800 border-t border-blue-700 shadow-xl">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <button onclick="app.navigate('dashboard')" class="mobile-nav-btn block px-3 py-3 rounded-md text-base font-medium text-white bg-blue-900 w-full text-left" data-target="dashboard">Dashboard</button>
                <button onclick="app.navigate('portofolio')" class="mobile-nav-btn block px-3 py-3 rounded-md text-base font-medium text-blue-200 hover:text-white hover:bg-blue-700 w-full text-left" data-target="portofolio">Kegiatan</button>
                <button onclick="app.navigate('kritik')" class="mobile-nav-btn block px-3 py-3 rounded-md text-base font-medium text-blue-200 hover:text-white hover:bg-blue-700 w-full text-left" data-target="kritik">Kritik & Saran</button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 md:py-8 relative">
        
        <!-- Loading Indicator -->
        <div id="loading-state" class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-50 hidden backdrop-blur-sm rounded-xl">
            <div class="loader mb-4"></div>
            <p class="text-blue-600 font-medium animate-pulse">Memuat Data...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden text-center py-12 md:py-20">
            <!-- Content filled by JS -->
        </div>

        <!-- VIEW: DASHBOARD -->
        <section id="view-dashboard" class="space-y-6 md:space-y-8 animate-fade-in">
            
            <!-- NEW: Jadwal Sholat Section (Updated Style) -->
            <div class="bg-gradient-to-r from-blue-900 to-emerald-800 rounded-2xl shadow-lg border border-blue-800 p-6 md:p-8 relative overflow-hidden text-white">
                <!-- Background Pattern (Same as Summary) -->
                <div class="absolute inset-0 opacity-10 pattern-bg" style="background-image: url('data:image/svg+xml,%3Csvg width=\'20\' height=\'20\' viewBox=\'0 0 20 20\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%23ffffff\' fill-opacity=\'1\' fill-rule=\'evenodd\'%3E%3Ccircle cx=\'3\' cy=\'3\' r=\'3\'/%3E%3Ccircle cx=\'13\' cy=\'13\' r=\'3\'/%3E%3C/g%3E%3C/svg%3E');"></div>
                
                <!-- Ornament Background -->
                <div class="absolute -right-6 -top-6 text-white opacity-5 transform rotate-12 pointer-events-none">
                    <i class="fas fa-kaaba text-9xl"></i>
                </div>
                
                <div class="relative z-10">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <div>
                            <h3 class="font-serif text-xl md:text-2xl font-bold text-white flex items-center">
                                <i class="far fa-clock mr-3 text-emerald-300"></i> Jadwal Sholat Hari Ini
                            </h3>
                            <p class="text-sm text-blue-100 mt-1 ml-1 opacity-90"><i class="fas fa-map-marker-alt mr-1"></i> Wilayah Kendal & Sekitarnya</p>
                        </div>
                        <div class="mt-4 md:mt-0 text-right">
                            <span id="prayer-date-display" class="text-sm font-medium text-white bg-white/10 px-4 py-2 rounded-full border border-white/20 backdrop-blur-md shadow-sm">
                                Memuat Tanggal...
                            </span>
                        </div>
                    </div>

                    <!-- Prayer Times Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 md:gap-4" id="prayer-times-container">
                        <!-- Loading State for Prayer Times -->
                        <div class="col-span-full text-center py-6 text-blue-200 text-sm animate-pulse flex flex-col items-center">
                            <div class="loader w-6 h-6 border-white/20 border-t-white mb-2"></div>
                            Mengambil jadwal sholat...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hero & Summary Section -->
            <div class="space-y-6">
                <!-- Summary Box -->
                <div class="flex flex-col md:flex-row items-center justify-between bg-gradient-to-r from-blue-900 to-emerald-800 p-6 md:p-8 rounded-2xl shadow-lg border border-blue-800 text-white relative overflow-hidden group">
                    <!-- Background Pattern -->
                    <div class="absolute inset-0 opacity-10 pattern-bg" style="background-image: url('data:image/svg+xml,%3Csvg width=\'20\' height=\'20\' viewBox=\'0 0 20 20\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%23ffffff\' fill-opacity=\'1\' fill-rule=\'evenodd\'%3E%3Ccircle cx=\'3\' cy=\'3\' r=\'3\'/%3E%3Ccircle cx=\'13\' cy=\'13\' r=\'3\'/%3E%3C/g%3E%3C/svg%3E');"></div>
                    
                    <div class="relative z-10 mb-6 md:mb-0 text-center md:text-left">
                        <h2 class="text-2xl md:text-3xl font-serif font-bold text-white tracking-wide">Ringkasan Keuangan</h2>
                        <p class="text-blue-100 text-xs md:text-sm mt-2 opacity-90" id="last-updated"><i class="far fa-clock mr-1"></i> Diperbarui: -</p>
                    </div>
                    
                    <!-- Saldo Card -->
                    <div class="relative z-10 w-full md:w-auto">
                        <div class="relative bg-white/10 backdrop-blur-md border border-white/20 text-white p-6 rounded-xl shadow-xl min-w-[280px] text-center md:text-right transition-transform hover:scale-[1.02]">
                            <p class="text-xs font-medium text-blue-100 uppercase tracking-wider mb-1">Saldo Kas Saat Ini</p>
                            <h3 class="text-3xl md:text-4xl font-bold tracking-tight" id="dash-balance">Rp 0</h3>
                            <div class="absolute top-0 left-0 p-4 opacity-10 text-white">
                                <i class="fas fa-wallet text-5xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <!-- Pemasukan -->
                    <div class="bg-emerald-50 rounded-xl p-5 md:p-6 border border-emerald-100 shadow-sm flex justify-between items-center hover:shadow-md transition-shadow">
                        <div>
                            <p class="text-xs md:text-sm font-bold text-emerald-600 uppercase tracking-wide">Total Pemasukan</p>
                            <h3 class="text-2xl md:text-3xl font-bold text-emerald-800 mt-1" id="dash-total-in">Rp 0</h3>
                        </div>
                        <div class="bg-emerald-100 p-3 rounded-full text-emerald-600 text-xl md:text-2xl">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                    </div>
                    <!-- Pengeluaran -->
                    <div class="bg-rose-50 rounded-xl p-5 md:p-6 border border-rose-100 shadow-sm flex justify-between items-center hover:shadow-md transition-shadow">
                        <div>
                            <p class="text-xs md:text-sm font-bold text-rose-600 uppercase tracking-wide">Total Pengeluaran</p>
                            <h3 class="text-2xl md:text-3xl font-bold text-rose-800 mt-1" id="dash-total-out">Rp 0</h3>
                        </div>
                        <div class="bg-rose-100 p-3 rounded-full text-rose-600 text-xl md:text-2xl">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaction Table Section -->
            <div class="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
                <!-- Toolbar -->
                <div class="p-4 md:p-6 border-b border-slate-100 bg-slate-50">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <h3 class="font-serif text-lg font-bold text-slate-800 flex items-center">
                            <i class="fas fa-list-ul mr-2 text-blue-600"></i> Rincian Transaksi
                        </h3>
                        
                        <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                            <!-- Filter Periode (Combined) -->
                            <div class="relative w-full sm:w-auto min-w-[200px]">
                                <select id="filter-month" onchange="app.handleFilterChange()" class="appearance-none w-full bg-white border border-slate-300 text-slate-700 text-sm rounded-lg pl-10 pr-8 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none cursor-pointer shadow-sm">
                                    <option value="all">Semua Periode</option>
                                    <!-- JS populated -->
                                </select>
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                    <i class="far fa-calendar-alt"></i>
                                </div>
                                <div class="select-icon-wrapper text-slate-400">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </div>
                            </div>

                            <!-- Filter Sort -->
                            <div class="relative w-full sm:w-auto min-w-[160px]">
                                <select id="filter-sort" onchange="app.handleFilterChange()" class="appearance-none w-full bg-white border border-slate-300 text-slate-700 text-sm rounded-lg pl-10 pr-8 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none cursor-pointer shadow-sm">
                                    <option value="newest">Terbaru</option>
                                    <option value="oldest">Terlama</option>
                                </select>
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                    <i class="fas fa-sort"></i>
                                </div>
                                <div class="select-icon-wrapper text-slate-400">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </div>
                            </div>

                            <!-- Download Button -->
                            <button onclick="app.exportToPDF()" class="w-full sm:w-auto inline-flex items-center justify-center bg-red-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium hover:bg-red-700 transition shadow-sm active:scale-95">
                                <i class="fas fa-file-pdf mr-2"></i> Unduh PDF
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Table Container -->
                <div class="overflow-x-auto table-container">
                    <table class="w-full text-sm text-left text-slate-600 min-w-[600px]" id="transaction-table">
                        <thead class="bg-slate-100 text-xs uppercase font-bold text-slate-600 tracking-wider">
                            <tr>
                                <th class="px-6 py-4 rounded-tl-lg whitespace-nowrap">Tanggal</th>
                                <th class="px-6 py-4 whitespace-nowrap">Kategori</th>
                                <th class="px-6 py-4 min-w-[200px]">Keterangan</th>
                                <th class="px-6 py-4 text-right whitespace-nowrap">Masuk</th>
                                <th class="px-6 py-4 text-right rounded-tr-lg whitespace-nowrap">Keluar</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-100">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="px-4 md:px-6 py-4 border-t border-slate-200 bg-slate-50 flex flex-col sm:flex-row items-center justify-between gap-4">
                    <span class="text-sm text-slate-500 text-center sm:text-left w-full sm:w-auto order-2 sm:order-1" id="pagination-info">
                        Menampilkan 0 - 0 dari 0 data
                    </span>
                    <div class="flex gap-2 w-full sm:w-auto justify-center sm:justify-end order-1 sm:order-2">
                        <button onclick="app.prevPage()" id="btn-prev" class="flex-1 sm:flex-none inline-flex items-center justify-center px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:text-slate-700 transition-all shadow-sm">
                            <i class="fas fa-chevron-left mr-2 text-xs"></i> Sebelumnya
                        </button>
                        <button onclick="app.nextPage()" id="btn-next" class="flex-1 sm:flex-none inline-flex items-center justify-center px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:text-slate-700 transition-all shadow-sm">
                            Selanjutnya <i class="fas fa-chevron-right ml-2 text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: PORTOFOLIO / KEGIATAN -->
        <section id="view-portofolio" class="space-y-6 hidden animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-serif font-bold text-slate-800">Dokumentasi Kegiatan</h2>
                    <p class="text-slate-600 mt-1">Kegiatan dan program yang telah terlaksana.</p>
                </div>
                <div class="bg-blue-50 text-blue-700 text-xs font-medium px-4 py-2 rounded-full border border-blue-100 flex items-center shadow-sm">
                    <i class="fas fa-info-circle mr-2"></i> Data dikelola via Google Sheets (Admin)
                </div>
            </div>
            
            <div id="portfolio-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- JS Injected Cards -->
            </div>
        </section>

        <!-- VIEW: KRITIK & SARAN -->
        <section id="view-kritik" class="hidden animate-fade-in">
            <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-lg border border-slate-200 p-6 md:p-10">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 text-blue-600 mb-4 shadow-inner">
                        <i class="fas fa-comment-dots text-3xl"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-serif font-bold text-slate-800">Kotak Saran</h2>
                    <p class="text-slate-500 mt-2">Masukan Anda sangat berarti untuk kemajuan Masjid Jami' Daarul Muttaqin.</p>
                </div>

                <form id="feedback-form" onsubmit="app.submitFeedback(event)" class="space-y-6">
                    <div>
                        <label for="feedback-name" class="block text-sm font-medium text-slate-700 mb-1">Nama (Opsional)</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="far fa-user text-slate-400"></i>
                            </div>
                            <input type="text" id="feedback-name" class="block w-full pl-10 pr-3 py-3 border border-slate-300 rounded-lg leading-5 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm shadow-sm" placeholder="Hamba Allah">
                        </div>
                    </div>
                    <div>
                        <label for="feedback-message" class="block text-sm font-medium text-slate-700 mb-1">Pesan / Kritik / Saran <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <textarea id="feedback-message" rows="5" required class="block w-full p-3 border border-slate-300 rounded-lg leading-5 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm shadow-sm" placeholder="Tuliskan masukan Anda di sini..."></textarea>
                        </div>
                    </div>
                    <button type="submit" id="btn-submit" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all hover:-translate-y-0.5">
                        <i class="fas fa-paper-plane mr-2"></i> Kirim Masukan
                    </button>
                </form>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-10 mt-auto border-t border-slate-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center md:text-left">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-12">
                <div>
                    <div class="flex items-center justify-center md:justify-start space-x-2 mb-4">
                        <div class="bg-slate-800 p-1.5 rounded-full">
                            <i class="fas fa-mosque text-blue-500 text-lg"></i>
                        </div>
                        <h3 class="text-white font-serif font-bold text-lg">Masjid Jami' Daarul Muttaqin</h3>
                    </div>
                    <p class="text-sm leading-relaxed opacity-80">Bulusari - Limbangan<br>Kendal, Jawa Tengah</p>
                </div>
                <div>
                    <h3 class="text-white font-serif font-bold text-lg mb-4">Navigasi</h3>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" onclick="app.navigate('dashboard')" class="hover:text-blue-400 transition-colors inline-block py-1">Dashboard</a></li>
                        <li><a href="#" onclick="app.navigate('portofolio')" class="hover:text-blue-400 transition-colors inline-block py-1">Kegiatan</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-white font-serif font-bold text-lg mb-4">Sosial Media</h3>
                    <div class="flex justify-center md:justify-start space-x-4">
                        <a href="#" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center hover:bg-emerald-600 hover:text-white transition-all hover:scale-110"><i class="fab fa-whatsapp text-lg"></i></a>
                        <a href="#" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center hover:bg-pink-600 hover:text-white transition-all hover:scale-110"><i class="fab fa-instagram text-lg"></i></a>
                        <a href="#" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center hover:bg-blue-600 hover:text-white transition-all hover:scale-110"><i class="fab fa-facebook text-lg"></i></a>
                    </div>
                </div>
            </div>
            <div class="border-t border-slate-800 mt-10 pt-8 text-xs text-center text-slate-600">
                &copy; 2026 Masjid Jami' Daarul Muttaqin.
            </div>
        </div>
    </footer>

    <!-- MAIN JAVASCRIPT LOGIC -->
    <script>
        const CONFIG = {
            // URL Web App Terbaru
            WEB_APP_URL: "https://script.google.com/macros/s/AKfycbxS8VsowU1wExGD8J8iScxLYXjsgx8_59bhh5id6tL3MuVUqk04KKEoTAUaXaDisd8p/exec" 
        };

        // Data Simulasi (Fallback) - Akan digunakan jika koneksi gagal
        const MockData = {
            transactions: [
                { tgl: "2023-12-01", kategori: "Infaq", keterangan: "Contoh: Infaq Jumat (Data Simulasi)", jumlah: 2500000, tipe: 'PEMASUKAN' },
                { tgl: "2023-12-05", kategori: "Operasional", keterangan: "Contoh: Listrik (Data Simulasi)", jumlah: 500000, tipe: 'PENGELUARAN' }
            ],
            activities: [
                { foto: 'https://images.unsplash.com/photo-1609599006353-e629aaabfeae?w=500&auto=format&fit=crop', nama: 'Contoh Kegiatan 1', deskripsi: 'Ini adalah contoh data jika koneksi gagal.' },
                { foto: 'https://images.unsplash.com/photo-1584620573918-091f974eb313?w=500&auto=format&fit=crop', nama: 'Contoh Kegiatan 2', deskripsi: 'Silakan periksa koneksi Google Sheets Anda.' }
            ]
        };

        const app = {
            data: {
                transactions: [], 
                activities: [],
                totals: { in: 0, out: 0, balance: 0 },
                uniquePeriods: []
            },
            state: {
                currentPage: 1,
                itemsPerPage: 20,
                filteredData: [],
                filterMonth: 'all',
                filterSort: 'newest'
            },

            init: async function() {
                this.setupNavigation();
                await this.fetchData();
                this.fetchPrayerTimes(); // Panggil fungsi jadwal sholat
            },

            // --- JADWAL SHOLAT API ---
            fetchPrayerTimes: async function() {
                const container = document.getElementById('prayer-times-container');
                const dateDisplay = document.getElementById('prayer-date-display');
                
                try {
                    // API Aladhan untuk Kendal, Indonesia, Method 20 (Kemenag RI)
                    const response = await fetch('https://api.aladhan.com/v1/timingsByCity?city=Kendal&country=Indonesia&method=20');
                    const result = await response.json();

                    if(result.code === 200) {
                        const timings = result.data.timings;
                        const date = result.data.date.readable;
                        
                        dateDisplay.innerText = date;
                        
                        // List Sholat - Uniform Style (Seragam)
                        const prayers = [
                            { name: 'Subuh', time: timings.Fajr },
                            { name: 'Dzuhur', time: timings.Dhuhr },
                            { name: 'Ashar', time: timings.Asr },
                            { name: 'Maghrib', time: timings.Maghrib },
                            { name: 'Isya', time: timings.Isha }
                        ];

                        let html = '';
                        prayers.forEach(p => {
                            html += `
                            <div class="flex flex-col items-center justify-center p-4 rounded-xl bg-white/10 backdrop-blur-sm border border-white/20 hover:bg-white/20 transition-all duration-300 group shadow-sm hover:-translate-y-1">
                                <span class="text-[10px] md:text-xs font-bold text-emerald-300 uppercase tracking-widest mb-1 group-hover:text-emerald-200 transition-colors">${p.name}</span>
                                <span class="text-2xl md:text-3xl font-serif font-bold text-white tracking-wide">${p.time}</span>
                            </div>`;
                        });
                        
                        container.innerHTML = html;
                    } else {
                        throw new Error('API Error');
                    }
                } catch (e) {
                    console.error("Gagal load jadwal sholat", e);
                    container.innerHTML = `<div class="col-span-full text-center text-red-200 bg-red-900/20 p-4 rounded-lg border border-red-500/30 text-sm">Gagal memuat jadwal. Periksa koneksi internet.</div>`;
                    dateDisplay.innerText = "-";
                }
            },

            // --- DATA UTAMA (SHEETS) ---
            fetchData: async function() {
                const loader = document.getElementById('loading-state');
                const errorState = document.getElementById('error-state');
                
                loader.classList.remove('hidden');
                errorState.classList.add('hidden');

                try {
                    // Coba ambil data dari Google Sheets (Standard Fetch)
                    const [resTrans, resAct] = await Promise.all([
                        fetch(`${CONFIG.WEB_APP_URL}?action=gettransactions&t=${Date.now()}`),
                        fetch(`${CONFIG.WEB_APP_URL}?action=getactivities&t=${Date.now()}`)
                    ]);

                    if (!resTrans.ok || !resAct.ok) throw new Error("Gagal mengambil data dari server");

                    const transJson = await resTrans.json();
                    const actJson = await resAct.json();

                    if (transJson.ok) {
                         this.processData(transJson.data);
                    } else {
                         throw new Error(transJson.error || "Gagal memuat transaksi");
                    }

                    if (actJson.ok) {
                        this.data.activities = actJson.data;
                    } else {
                        this.data.activities = [];
                    }
                    
                    this.renderAll();
                    loader.classList.add('hidden');
                    
                    // Update timestamp
                    const now = new Date();
                    document.getElementById('last-updated').innerHTML = `<i class="fas fa-check-circle text-emerald-300 mr-1"></i> Diperbarui: ${now.toLocaleTimeString('id-ID')}`;

                } catch (error) {
                    console.warn("Gagal koneksi ke Google Sheets, beralih ke Data Simulasi.", error);
                    
                    // FALLBACK: Gunakan Mock Data agar tampilan tidak rusak
                    this.processData(MockData.transactions); 
                    this.data.activities = MockData.activities;
                    this.renderAll();

                    loader.classList.add('hidden');
                    
                    // Tampilkan notifikasi toast
                    this.showToast("Mode Offline: Menampilkan data simulasi.", "warning");
                    
                    document.getElementById('last-updated').innerHTML = `<i class="fas fa-exclamation-triangle text-yellow-300 mr-1"></i> Mode Simulasi`;
                }
            },

            processData: function(rawTransactions) {
                const periods = new Set();

                this.data.transactions = rawTransactions.map(item => {
                    const tgl = item.tgl || item.date || "";
                    const kat = item.kategori || item.category || "";
                    const ket = item.keterangan || item.desc || "";
                    const jum = (item.jumlah !== undefined && item.jumlah !== "") ? item.jumlah : 
                                (item.amount !== undefined && item.amount !== "") ? item.amount : 0;
                    const tipeRaw = item.tipe || item.type || "";

                    const tipeStr = (tipeRaw || '').toUpperCase();
                    const isMasuk = tipeStr.includes('MASUK') || tipeStr.includes('IN') || tipeStr === 'PEMASUKAN' || tipeStr === 'INFAQ';
                    
                    if (tgl && tgl.length >= 7) {
                        periods.add(tgl.substring(0, 7)); // YYYY-MM
                    }

                    return {
                        date: tgl,            
                        category: kat,   
                        desc: ket,     
                        amount: parseInt(jum) || 0, 
                        type: isMasuk ? 'in' : 'out',
                        originalType: tipeRaw
                    };
                });

                this.data.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                this.data.totals.in = this.data.transactions
                    .filter(t => t.type === 'in')
                    .reduce((sum, item) => sum + item.amount, 0);
                    
                this.data.totals.out = this.data.transactions
                    .filter(t => t.type === 'out')
                    .reduce((sum, item) => sum + item.amount, 0);
                    
                this.data.totals.balance = this.data.totals.in - this.data.totals.out;

                this.data.uniquePeriods = Array.from(periods).sort().reverse();
                const monthSelect = document.getElementById('filter-month');
                monthSelect.innerHTML = '<option value="all">Semua Periode</option>';
                
                this.data.uniquePeriods.forEach(ym => {
                    const [year, month] = ym.split('-');
                    const date = new Date(year, month - 1);
                    const label = date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                    monthSelect.innerHTML += `<option value="${ym}">${label}</option>`;
                });
            },

            renderAll: function() {
                this.renderSummary();
                this.handleFilterChange();
                this.renderPortfolio();
            },

            renderSummary: function() {
                document.getElementById('dash-total-in').innerText = this.formatCurrency(this.data.totals.in);
                document.getElementById('dash-total-out').innerText = this.formatCurrency(this.data.totals.out);
                document.getElementById('dash-balance').innerText = this.formatCurrency(this.data.totals.balance);
            },

            handleFilterChange: function() {
                this.state.filterMonth = document.getElementById('filter-month').value;
                this.state.filterSort = document.getElementById('filter-sort').value;
                this.state.currentPage = 1;

                this.state.filteredData = this.data.transactions.filter(t => {
                    if (this.state.filterMonth === 'all') return true;
                    return t.date.startsWith(this.state.filterMonth);
                });

                this.state.filteredData.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return this.state.filterSort === 'newest' ? dateB - dateA : dateA - dateB;
                });

                this.renderTable();
            },

            renderTable: function() {
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '';

                const start = (this.state.currentPage - 1) * this.state.itemsPerPage;
                const end = start + this.state.itemsPerPage;
                const pageData = this.state.filteredData.slice(start, end);
                const totalItems = this.state.filteredData.length;

                if (totalItems === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400 italic bg-slate-50/50">Tidak ada data untuk periode ini.</td></tr>';
                    document.getElementById('pagination-info').innerText = '0 data';
                    document.getElementById('btn-prev').disabled = true;
                    document.getElementById('btn-next').disabled = true;
                    return;
                }

                pageData.forEach(t => {
                    const amountIn = t.type === 'in' ? this.formatCurrency(t.amount) : '-';
                    const amountOut = t.type === 'out' ? this.formatCurrency(t.amount) : '-';
                    
                    const row = `
                        <tr class="bg-white border-b hover:bg-slate-50 transition duration-150">
                            <td class="px-6 py-4 whitespace-nowrap text-slate-700 font-medium">${this.formatDate(t.date)}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-3 py-1 rounded-full text-xs font-bold ${t.type === 'in' ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800'}">
                                    ${t.category || ""}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-slate-600">${t.desc}</td>
                            <td class="px-6 py-4 text-right font-bold text-emerald-600 whitespace-nowrap">${amountIn}</td>
                            <td class="px-6 py-4 text-right font-bold text-rose-600 whitespace-nowrap">${amountOut}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                document.getElementById('pagination-info').innerText = `Menampilkan ${start + 1} - ${Math.min(end, totalItems)} dari ${totalItems} data`;
                document.getElementById('btn-prev').disabled = this.state.currentPage === 1;
                document.getElementById('btn-next').disabled = end >= totalItems;
            },

            nextPage: function() {
                if ((this.state.currentPage * this.state.itemsPerPage) < this.state.filteredData.length) {
                    this.state.currentPage++;
                    this.renderTable();
                    document.getElementById('transaction-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            },

            prevPage: function() {
                if (this.state.currentPage > 1) {
                    this.state.currentPage--;
                    this.renderTable();
                    document.getElementById('transaction-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            },

            renderPortfolio: function() {
                const container = document.getElementById('portfolio-grid');
                container.innerHTML = ''; 

                if (!this.data.activities || this.data.activities.length === 0) {
                    container.innerHTML = `
                       <div class="col-span-full text-center py-12 bg-white rounded-xl border-2 border-dashed border-slate-300">
                           <div class="mx-auto h-16 w-16 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                               <i class="far fa-images text-3xl text-slate-400"></i>
                           </div>
                           <h3 class="text-base font-medium text-slate-900">Belum ada dokumentasi</h3>
                           <p class="mt-1 text-sm text-slate-500">
                               Pastikan Sheet "Kegiatan" ada dan kolom "Nama" & "Foto" terisi.<br>
                               Cek juga akses foto di Google Drive harus "Anyone with the link".
                           </p>
                       </div>`;
                    return;
                }

                this.data.activities.forEach(item => {
                    const imgUrl = item.foto && item.foto.trim() !== '' ? item.foto : '';
                    
                    // Logic Update: Tampilkan placeholder jika gambar error/kosong
                    let imgElement;
                    if (imgUrl) {
                        imgElement = `
                        <div class="h-48 overflow-hidden bg-slate-100 relative group-hover:opacity-90 transition">
                            <img src="${imgUrl}" alt="${item.nama || ''}" 
                                 class="w-full h-full object-cover transform group-hover:scale-110 transition duration-700" 
                                 onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'w-full h-full flex flex-col items-center justify-center text-slate-400 bg-slate-100\'><i class=\'fas fa-image-slash text-2xl mb-2\'></i><span class=\'text-xs px-4 text-center\'>Gagal Memuat Gambar<br>(Cek Izin Drive)</span></div>';">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        </div>`;
                    } else {
                        imgElement = `
                        <div class="h-48 overflow-hidden bg-slate-100 flex flex-col items-center justify-center text-slate-400">
                            <i class="far fa-image text-3xl mb-2"></i>
                            <span class="text-xs">Tidak ada foto</span>
                        </div>`;
                    }

                    container.innerHTML += `
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-lg transition-all duration-300 group hover:-translate-y-1">
                            ${imgElement}
                            <div class="p-6">
                                <div class="flex items-center justify-between text-xs text-slate-400 mb-2.5">
                                    <span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide">Kegiatan</span>
                                    <span>${this.formatDate(item.date)}</span>
                                </div>
                                <h3 class="font-serif font-bold text-lg text-slate-800 mb-2 group-hover:text-blue-600 transition leading-tight">${item.nama || "(Tanpa Nama)"}</h3>
                                ${item.deskripsi ? `<p class="text-sm text-slate-600 line-clamp-3 leading-relaxed">${item.deskripsi}</p>` : ''}
                            </div>
                        </div>
                    `;
                });
            },

            navigate: function(targetId) {
                document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(btn => {
                    const isActive = btn.dataset.target === targetId;
                    if(btn.classList.contains('nav-btn')) {
                        btn.classList.toggle('bg-blue-700', isActive);
                        btn.classList.toggle('shadow-sm', isActive);
                        btn.classList.toggle('text-white', isActive);
                        if(!isActive) {
                             btn.classList.remove('bg-blue-700', 'shadow-sm');
                             btn.classList.add('text-blue-100');
                        } else {
                             btn.classList.remove('text-blue-100');
                        }
                    }
                });

                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${targetId}`).classList.remove('hidden');
                document.getElementById('mobile-menu').classList.add('hidden');
                window.scrollTo(0, 0);
            },

            toggleMobileMenu: function() {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            },

            exportToPDF: function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const monthSelect = document.getElementById('filter-month');
                const period = monthSelect.options[monthSelect.selectedIndex].text;
                
                doc.setFillColor(30, 64, 175);
                doc.rect(0, 0, 210, 28, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text("LAPORAN KAS Masjid Jami' Daarul Muttaqin", 105, 14, null, null, "center");
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text("Bulusari - Limbangan, Kendal", 105, 20, null, null, "center");
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.text(`Periode: ${period}`, 14, 38);
                doc.text(`Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}`, 14, 43);

                const tableData = this.state.filteredData.map(t => [
                    this.formatDate(t.date),
                    t.category,
                    t.desc,
                    t.type === 'in' ? this.formatCurrency(t.amount) : '-',
                    t.type === 'out' ? this.formatCurrency(t.amount) : '-'
                ]);

                doc.autoTable({
                    startY: 48,
                    head: [['Tanggal', 'Kategori', 'Keterangan', 'Masuk', 'Keluar']],
                    body: tableData,
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 3, lineColor: [200, 200, 200] },
                    headStyles: { fillColor: [30, 64, 175], textColor: 255, fontStyle: 'bold', halign: 'center' },
                    columnStyles: {
                        0: { cellWidth: 30 },
                        3: { halign: 'right', textColor: [5, 150, 105] }, 
                        4: { halign: 'right', textColor: [220, 38, 38] }
                    },
                    alternateRowStyles: { fillColor: [248, 250, 252] }
                });

                const finalY = doc.lastAutoTable.finalY + 10;
                
                doc.setDrawColor(200, 200, 200);
                doc.line(110, finalY - 2, 200, finalY - 2);
                
                doc.setFontSize(9);
                doc.text("Total Pemasukan:", 120, finalY + 4);
                doc.text(this.formatCurrency(this.data.totals.in), 195, finalY + 4, null, null, "right");
                
                doc.text("Total Pengeluaran:", 120, finalY + 9);
                doc.text(this.formatCurrency(this.data.totals.out), 195, finalY + 9, null, null, "right");
                
                doc.setFillColor(240, 249, 255);
                doc.rect(115, finalY + 13, 85, 10, 'F');
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(30, 64, 175);
                doc.text("Saldo Akhir:", 120, finalY + 20);
                doc.text(this.formatCurrency(this.data.totals.balance), 195, finalY + 20, null, null, "right");

                doc.save(`Laporan_Kas_Masjid.pdf`);
            },

            formatCurrency: function(num) {
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
            },
            formatDate: function(dateString) {
                if(!dateString) return '-';
                return new Date(dateString).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
            },
            
            showToast: function(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const bg = type === 'success' ? 'bg-emerald-600' : (type === 'warning' ? 'bg-yellow-500' : 'bg-red-600');
                
                toast.className = `${bg} text-white px-6 py-3 rounded-lg shadow-lg mb-3 transition transform translate-x-full duration-300 flex items-center pointer-events-auto`;
                toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-3"></i> ${message}`;
                
                container.appendChild(toast);
                
                // Animate In
                setTimeout(() => toast.classList.remove('translate-x-full'), 10);
                
                // Remove after 3s
                setTimeout(() => {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            submitFeedback: async function(e) {
                e.preventDefault();
                const btn = document.getElementById('btn-submit');
                const originalText = btn.innerHTML;
                const name = document.getElementById('feedback-name').value;
                const message = document.getElementById('feedback-message').value;

                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Mengirim...';
                btn.disabled = true;

                try {
                    await fetch(CONFIG.WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'feedback', name, message })
                    });

                    this.showToast("Terima kasih! Masukan Anda telah diterima.");
                    document.getElementById('feedback-form').reset();
                } catch (err) {
                    this.showToast("Gagal mengirim pesan. Silakan coba lagi.", "error");
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        };
        
        app.setupNavigation = function() { };

        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
