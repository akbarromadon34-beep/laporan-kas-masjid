<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Informasi & Laporan Kas Masjid</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome & Google Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- jsPDF & AutoTable untuk Export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Konfigurasi Tailwind & Custom Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Amiri', 'serif'],
                    },
                    colors: {
                        emerald: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            600: '#059669',
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                        },
                        blue: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .islamic-pattern {
            background-color: #f8fafc;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231e40af' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* Blue loader */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for table on mobile */
        .table-container::-webkit-scrollbar {
            height: 6px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        /* Scrollbar hide utility for carousel */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .select-icon-wrapper {
            pointer-events: none;
            position: absolute;
            inset-y: 0;
            right: 0;
            display: flex;
            align-items: center;
            padding-right: 0.75rem;
        }
        /* Smooth scroll for slider */
        .scroll-smooth {
            scroll-behavior: smooth;
        }
        
        /* Modal Animation */
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
    </style>
</head>
<body class="islamic-pattern text-slate-800 antialiased min-h-screen flex flex-col">

    <!-- Notifikasi Toast -->
    <div id="toast-container" class="fixed top-4 right-4 z-[60] pointer-events-none"></div>

    <!-- Header / Navbar -->
    <nav class="bg-gradient-to-r from-blue-900 to-blue-800 text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center space-x-3">
                    <div class="bg-white p-1.5 rounded-full shadow-md">
                        <i class="fas fa-mosque text-blue-800 text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-serif text-xl font-bold tracking-wide leading-none">Masjid Jami' Daarul Muttaqin</h1>
                        <p class="text-[10px] text-blue-100 uppercase tracking-wider hidden sm:block mt-1">Transparansi Keuangan</p>
                    </div>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center space-x-4">
                    <button onclick="app.navigate('dashboard')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700/50 transition-all bg-blue-700 shadow-sm" data-target="dashboard">Dashboard</button>
                    <button onclick="app.navigate('portofolio')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700/50 transition-all text-blue-100" data-target="portofolio">Kegiatan</button>
                    <button onclick="app.navigate('kritik')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700/50 transition-all text-blue-100" data-target="kritik">Kritik & Saran</button>
                    <!-- NEW: Admin Button -->
                    <button onclick="app.openAdminAuth()" class="px-4 py-2 rounded-lg text-sm font-medium bg-emerald-600 hover:bg-emerald-700 text-white shadow-md transition-all flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i> Transaksi Baru
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <div class="-mr-2 flex md:hidden">
                    <button onclick="app.toggleMobileMenu()" class="bg-blue-800 inline-flex items-center justify-center p-2 rounded-md text-blue-100 hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-blue-800 focus:ring-white">
                        <i class="fas fa-bars text-lg"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu Panel -->
        <div id="mobile-menu" class="hidden md:hidden bg-blue-800 border-t border-blue-700 shadow-xl">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <button onclick="app.navigate('dashboard')" class="mobile-nav-btn block px-3 py-3 rounded-md text-base font-medium text-white bg-blue-900 w-full text-left" data-target="dashboard">Dashboard</button>
                <button onclick="app.navigate('portofolio')" class="mobile-nav-btn block px-3 py-3 rounded-md text-base font-medium text-blue-200 hover:text-white hover:bg-blue-700 w-full text-left" data-target="portofolio">Kegiatan</button>
                <button onclick="app.navigate('kritik')" class="mobile-nav-btn block px-3 py-3 rounded-md text-base font-medium text-blue-200 hover:text-white hover:bg-blue-700 w-full text-left" data-target="kritik">Kritik & Saran</button>
                <button onclick="app.openAdminAuth()" class="mobile-nav-btn block px-3 py-3 rounded-md text-base font-medium text-emerald-300 hover:text-white hover:bg-emerald-700 w-full text-left border-t border-blue-700 mt-2">
                    <i class="fas fa-plus-circle mr-2"></i> Transaksi Baru (Admin)
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 md:py-8 relative">
        
        <!-- Loading Indicator -->
        <div id="loading-state" class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-50 hidden backdrop-blur-sm rounded-xl">
            <div class="loader mb-4"></div>
            <p class="text-blue-600 font-medium animate-pulse">Memuat Data...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden text-center py-12 md:py-20">
            <!-- Content filled by JS -->
        </div>

        <!-- VIEW: DASHBOARD -->
        <section id="view-dashboard" class="space-y-6 md:space-y-8 animate-fade-in">
            
            <!-- NEW: Jadwal Sholat Section (Updated Style) -->
            <div class="bg-gradient-to-r from-blue-900 to-emerald-800 rounded-2xl shadow-lg border border-blue-800 p-6 md:p-8 relative overflow-hidden text-white">
                <!-- Background Pattern (Same as Summary) -->
                <div class="absolute inset-0 opacity-10 pattern-bg" style="background-image: url('data:image/svg+xml,%3Csvg width=\'20\' height=\'20\' viewBox=\'0 0 20 20\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%23ffffff\' fill-opacity=\'1\' fill-rule=\'evenodd\'%3E%3Ccircle cx=\'3\' cy=\'3\' r=\'3\'/%3E%3Ccircle cx=\'13\' cy=\'13\' r=\'3\'/%3E%3C/g%3E%3C/svg%3E');"></div>
                
                <!-- Ornament Background -->
                <div class="absolute -right-6 -top-6 text-white opacity-5 transform rotate-12 pointer-events-none">
                    <i class="fas fa-kaaba text-9xl"></i>
                </div>
                
                <div class="relative z-10">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <div>
                            <h3 class="font-serif text-xl md:text-2xl font-bold text-white flex items-center">
                                <i class="far fa-clock mr-3 text-emerald-300"></i> Jadwal Sholat Hari Ini
                            </h3>
                            <p class="text-sm text-blue-100 mt-1 ml-1 opacity-90"><i class="fas fa-map-marker-alt mr-1"></i> Wilayah Kendal & Sekitarnya</p>
                        </div>
                        <div class="mt-4 md:mt-0 text-right">
                            <span id="prayer-date-display" class="text-sm font-medium text-white bg-white/10 px-4 py-2 rounded-full border border-white/20 backdrop-blur-md shadow-sm">
                                Memuat Tanggal...
                            </span>
                        </div>
                    </div>

                    <!-- Prayer Times Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 md:gap-4" id="prayer-times-container">
                        <!-- Loading State for Prayer Times -->
                        <div class="col-span-full text-center py-6 text-blue-200 text-sm animate-pulse flex flex-col items-center">
                            <div class="loader w-6 h-6 border-white/20 border-t-white mb-2"></div>
                            Mengambil jadwal sholat...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hero & Summary Section -->
            <div class="space-y-6">
                <!-- Summary Box -->
                <div class="flex flex-col md:flex-row items-center justify-between bg-gradient-to-r from-blue-900 to-emerald-800 p-6 md:p-8 rounded-2xl shadow-lg border border-blue-800 text-white relative overflow-hidden group">
                    <!-- Background Pattern -->
                    <div class="absolute inset-0 opacity-10 pattern-bg" style="background-image: url('data:image/svg+xml,%3Csvg width=\'20\' height=\'20\' viewBox=\'0 0 20 20\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%23ffffff\' fill-opacity=\'1\' fill-rule=\'evenodd\'%3E%3Ccircle cx=\'3\' cy=\'3\' r=\'3\'/%3E%3Ccircle cx=\'13\' cy=\'13\' r=\'3\'/%3E%3C/g%3E%3C/svg%3E');"></div>
                    
                    <div class="relative z-10 mb-6 md:mb-0 text-center md:text-left">
                        <h2 class="text-2xl md:text-3xl font-serif font-bold text-white tracking-wide">Ringkasan Keuangan</h2>
                        <p class="text-blue-100 text-xs md:text-sm mt-2 opacity-90" id="last-updated"><i class="far fa-clock mr-1"></i> Diperbarui: -</p>
                    </div>
                    
                    <!-- Saldo Card -->
                    <div class="relative z-10 w-full md:w-auto">
                        <div class="relative bg-white/10 backdrop-blur-md border border-white/20 text-white p-6 rounded-xl shadow-xl min-w-[280px] text-center md:text-right transition-transform hover:scale-[1.02]">
                            <p class="text-xs font-medium text-blue-100 uppercase tracking-wider mb-1">Saldo Kas Saat Ini</p>
                            <h3 class="text-3xl md:text-4xl font-bold tracking-tight" id="dash-balance">Rp 0</h3>
                            <div class="absolute top-0 left-0 p-4 opacity-10 text-white">
                                <i class="fas fa-wallet text-5xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <!-- Pemasukan -->
                    <div class="bg-emerald-50 rounded-xl p-5 md:p-6 border border-emerald-100 shadow-sm flex justify-between items-center hover:shadow-md transition-shadow">
                        <div>
                            <p class="text-xs md:text-sm font-bold text-emerald-600 uppercase tracking-wide">Total Pemasukan</p>
                            <h3 class="text-2xl md:text-3xl font-bold text-emerald-800 mt-1" id="dash-total-in">Rp 0</h3>
                        </div>
                        <div class="bg-emerald-100 p-3 rounded-full text-emerald-600 text-xl md:text-2xl">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                    </div>
                    <!-- Pengeluaran -->
                    <div class="bg-rose-50 rounded-xl p-5 md:p-6 border border-rose-100 shadow-sm flex justify-between items-center hover:shadow-md transition-shadow">
                        <div>
                            <p class="text-xs md:text-sm font-bold text-rose-600 uppercase tracking-wide">Total Pengeluaran</p>
                            <h3 class="text-2xl md:text-3xl font-bold text-rose-800 mt-1" id="dash-total-out">Rp 0</h3>
                        </div>
                        <div class="bg-rose-100 p-3 rounded-full text-rose-600 text-xl md:text-2xl">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaction Table Section -->
            <div class="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
                <!-- Toolbar -->
                <div class="p-4 md:p-6 border-b border-slate-100 bg-slate-50">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <h3 class="font-serif text-lg font-bold text-slate-800 flex items-center">
                            <i class="fas fa-list-ul mr-2 text-blue-600"></i> Rincian Transaksi
                        </h3>
                        
                        <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                            <!-- Filter Periode (Combined) -->
                            <div class="relative w-full sm:w-auto min-w-[200px]">
                                <select id="filter-month" onchange="app.handleFilterChange()" class="appearance-none w-full bg-white border border-slate-300 text-slate-700 text-sm rounded-lg pl-10 pr-8 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none cursor-pointer shadow-sm">
                                    <option value="all">Semua Periode</option>
                                    <!-- JS populated -->
                                </select>
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                    <i class="far fa-calendar-alt"></i>
                                </div>
                                <div class="select-icon-wrapper text-slate-400">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </div>
                            </div>

                            <!-- Filter Sort -->
                            <div class="relative w-full sm:w-auto min-w-[160px]">
                                <select id="filter-sort" onchange="app.handleFilterChange()" class="appearance-none w-full bg-white border border-slate-300 text-slate-700 text-sm rounded-lg pl-10 pr-8 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none cursor-pointer shadow-sm">
                                    <option value="newest">Terbaru</option>
                                    <option value="oldest">Terlama</option>
                                </select>
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                    <i class="fas fa-sort"></i>
                                </div>
                                <div class="select-icon-wrapper text-slate-400">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </div>
                            </div>

                            <!-- Download Button -->
                            <button onclick="app.exportToPDF()" class="w-full sm:w-auto inline-flex items-center justify-center bg-red-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium hover:bg-red-700 transition shadow-sm active:scale-95">
                                <i class="fas fa-file-pdf mr-2"></i> Unduh PDF
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Table Container -->
                <div class="overflow-x-auto table-container">
                    <table class="w-full text-sm text-left text-slate-600 min-w-[600px]" id="transaction-table">
                        <thead class="bg-slate-100 text-xs uppercase font-bold text-slate-600 tracking-wider">
                            <tr>
                                <th class="px-6 py-4 rounded-tl-lg whitespace-nowrap">Tanggal</th>
                                <th class="px-6 py-4 whitespace-nowrap">Kategori</th>
                                <th class="px-6 py-4 min-w-[200px]">Keterangan</th>
                                <th class="px-6 py-4 text-right whitespace-nowrap">Masuk</th>
                                <th class="px-6 py-4 text-right rounded-tr-lg whitespace-nowrap">Keluar</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-100">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="px-4 md:px-6 py-4 border-t border-slate-200 bg-slate-50 flex flex-col sm:flex-row items-center justify-between gap-4">
                    <span class="text-sm text-slate-500 text-center sm:text-left w-full sm:w-auto order-2 sm:order-1" id="pagination-info">
                        Menampilkan 0 - 0 dari 0 data
                    </span>
                    <div class="flex gap-2 w-full sm:w-auto justify-center sm:justify-end order-1 sm:order-2">
                        <button onclick="app.prevPage()" id="btn-prev" class="flex-1 sm:flex-none inline-flex items-center justify-center px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:text-slate-700 transition-all shadow-sm">
                            <i class="fas fa-chevron-left mr-2 text-xs"></i> Sebelumnya
                        </button>
                        <button onclick="app.nextPage()" id="btn-next" class="flex-1 sm:flex-none inline-flex items-center justify-center px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:text-slate-700 transition-all shadow-sm">
                            Selanjutnya <i class="fas fa-chevron-right ml-2 text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: PORTOFOLIO / KEGIATAN -->
        <section id="view-portofolio" class="space-y-6 hidden animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-serif font-bold text-slate-800">Dokumentasi Kegiatan</h2>
                    <p class="text-slate-600 mt-1">Galeri kegiatan dan program yang telah terlaksana.</p>
                </div>
                <div class="bg-blue-50 text-blue-700 text-xs font-medium px-4 py-2 rounded-full border border-blue-100 flex items-center shadow-sm">
                    <i class="fas fa-info-circle mr-2"></i> Data dikelola via Google Sheets (Admin)
                </div>
            </div>

            <!-- Hari Besar Islam 2026 -->
            <div class="bg-white rounded-2xl shadow-sm border border-emerald-100 p-6 mb-2">
                <h3 class="font-serif text-xl font-bold text-emerald-900 mb-4 flex items-center">
                    <i class="far fa-calendar-alt mr-2 text-emerald-600"></i> Hari Besar Islam <span id="current-year-display" class="ml-1"></span>
                </h3>
                <div id="islamic-holidays-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="col-span-full text-center py-4 text-slate-400 text-sm animate-pulse">
                        Menghitung kalender hijriyah...
                    </div>
                </div>
            </div>
            
            <div id="portfolio-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- JS Injected Cards -->
            </div>
        </section>

        <!-- VIEW: KRITIK & SARAN -->
        <section id="view-kritik" class="hidden animate-fade-in">
            <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-lg border border-slate-200 p-6 md:p-10">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 text-blue-600 mb-4 shadow-inner">
                        <i class="fas fa-comment-dots text-3xl"></i>
                    </div>
                    <h2 class="text-2xl md:text-3xl font-serif font-bold text-slate-800">Kotak Saran</h2>
                    <p class="text-slate-500 mt-2">Masukan Anda sangat berarti untuk kemajuan Masjid Jami' Daarul Muttaqin.</p>
                </div>

                <form id="feedback-form" onsubmit="app.submitFeedback(event)" class="space-y-6">
                    <div>
                        <label for="feedback-name" class="block text-sm font-medium text-slate-700 mb-1">Nama (Opsional)</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="far fa-user text-slate-400"></i>
                            </div>
                            <input type="text" id="feedback-name" class="block w-full pl-10 pr-3 py-3 border border-slate-300 rounded-lg leading-5 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm shadow-sm" placeholder="Hamba Allah">
                        </div>
                    </div>
                    <div>
                        <label for="feedback-message" class="block text-sm font-medium text-slate-700 mb-1">Pesan / Kritik / Saran <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <textarea id="feedback-message" rows="5" required class="block w-full p-3 border border-slate-300 rounded-lg leading-5 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm shadow-sm" placeholder="Tuliskan masukan Anda di sini..."></textarea>
                        </div>
                    </div>
                    <button type="submit" id="btn-submit" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all hover:-translate-y-0.5">
                        <i class="fas fa-paper-plane mr-2"></i> Kirim Masukan
                    </button>
                </form>
            </div>
        </section>

    </main>

    <!-- MODAL: PIN ADMIN -->
    <div id="modal-pin" class="fixed inset-0 z-50 hidden opacity-0 transition-opacity duration-300 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm mx-4 transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-bold text-center text-slate-800 mb-4">Akses Admin</h3>
            <p class="text-sm text-center text-slate-500 mb-6">Masukkan PIN untuk melanjutkan</p>
            
            <input type="password" id="pin-input" class="w-full text-center text-2xl tracking-[0.5em] font-bold border-2 border-slate-200 rounded-lg py-3 focus:outline-none focus:border-blue-500 mb-6" maxlength="6" placeholder="******">
            
            <div class="flex gap-3">
                <button onclick="app.closeModal('modal-pin')" class="flex-1 py-3 text-sm font-medium text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200">Batal</button>
                <button onclick="app.verifyPin()" class="flex-1 py-3 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 shadow-md">Masuk</button>
            </div>
        </div>
    </div>

    <!-- MODAL: TRANSAKSI BARU -->
    <div id="modal-transaction" class="fixed inset-0 z-50 hidden opacity-0 transition-opacity duration-300 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 transform scale-95 transition-transform duration-300 max-h-[90vh] overflow-y-auto">
            <div class="bg-blue-600 p-4 rounded-t-2xl flex justify-between items-center">
                <h3 class="text-lg font-bold text-white"><i class="fas fa-plus-circle mr-2"></i> Transaksi Baru</h3>
                <button onclick="app.closeModal('modal-transaction')" class="text-white hover:bg-blue-700 rounded-full p-1"><i class="fas fa-times"></i></button>
            </div>
            
            <form id="transaction-form" onsubmit="app.submitTransaction(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1 uppercase">Jenis Transaksi</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="cursor-pointer">
                            <input type="radio" name="tipe" value="PEMASUKAN" class="peer sr-only" checked>
                            <div class="text-center py-3 rounded-lg border-2 border-slate-200 text-slate-500 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 peer-checked:text-emerald-700 font-bold transition-all">
                                <i class="fas fa-arrow-down mr-1"></i> Pemasukan
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="tipe" value="PENGELUARAN" class="peer sr-only">
                            <div class="text-center py-3 rounded-lg border-2 border-slate-200 text-slate-500 peer-checked:border-rose-500 peer-checked:bg-rose-50 peer-checked:text-rose-700 font-bold transition-all">
                                <i class="fas fa-arrow-up mr-1"></i> Pengeluaran
                            </div>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1 uppercase">Tanggal</label>
                    <input type="date" id="trx-date" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1 uppercase">Kategori</label>
                    <input type="text" id="trx-category" list="category-list" required placeholder="Contoh: Infaq Jumat" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <datalist id="category-list">
                        <option value="Infaq Jumat">
                        <option value="Operasional">
                        <option value="Kebersihan">
                        <option value="Donasi">
                        <option value="Pembangunan">
                    </datalist>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1 uppercase">Jumlah (Rp)</label>
                    <input type="number" id="trx-amount" required placeholder="0" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg font-bold">
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1 uppercase">Keterangan (Opsional)</label>
                    <textarea id="trx-desc" rows="2" placeholder="Detail transaksi..." class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>

                <div class="pt-2">
                    <button type="submit" id="btn-save-trx" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-md transition-all">
                        Simpan Transaksi
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: LIGHTBOX (Popup Zoom) - IMPROVED -->
    <div id="modal-lightbox" class="fixed inset-0 z-[70] hidden opacity-0 transition-opacity duration-300 flex items-center justify-center bg-black/95 backdrop-blur-md" onclick="app.closeModal('modal-lightbox')">
        <div class="relative w-full h-full p-4 flex items-center justify-center">
            
            <!-- Close Button -->
            <button class="absolute top-4 right-4 z-[90] text-white/80 hover:text-white bg-black/30 hover:bg-black/50 rounded-full p-3 transition-all focus:outline-none" onclick="app.closeModal('modal-lightbox')">
                <i class="fas fa-times text-2xl"></i>
            </button>

            <!-- Nav Prev -->
            <button id="lb-prev" onclick="event.stopPropagation(); app.slideLightbox(-1)" class="absolute left-4 top-1/2 -translate-y-1/2 z-[80] text-white/70 hover:text-white bg-black/30 hover:bg-black/60 rounded-full w-12 h-12 flex items-center justify-center transition-all focus:outline-none hidden">
                <i class="fas fa-chevron-left text-3xl"></i>
            </button>

            <!-- Image Wrapper -->
            <div class="relative max-w-full max-h-full flex items-center justify-center" onclick="event.stopPropagation()">
                 <img id="lightbox-img" src="" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl transform scale-95 transition-transform duration-300 select-none">
                 <!-- Counter -->
                 <div id="lb-counter" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/60 text-white text-sm px-3 py-1.5 rounded-full backdrop-blur-sm pointer-events-none hidden">
                    1 / 1
                 </div>
            </div>

            <!-- Nav Next -->
            <button id="lb-next" onclick="event.stopPropagation(); app.slideLightbox(1)" class="absolute right-4 top-1/2 -translate-y-1/2 z-[80] text-white/70 hover:text-white bg-black/30 hover:bg-black/60 rounded-full w-12 h-12 flex items-center justify-center transition-all focus:outline-none hidden">
                <i class="fas fa-chevron-right text-3xl"></i>
            </button>
            
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-10 mt-auto border-t border-slate-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center md:text-left">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-12">
                <div>
                    <div class="flex items-center justify-center md:justify-start space-x-2 mb-4">
                        <div class="bg-slate-800 p-1.5 rounded-full">
                            <i class="fas fa-mosque text-blue-500 text-lg"></i>
                        </div>
                        <h3 class="text-white font-serif font-bold text-lg">Masjid Jami' Daarul Muttaqin</h3>
                    </div>
                    <p class="text-sm leading-relaxed opacity-80">Bulusari - Limbangan<br>Kendal, Jawa Tengah</p>
                </div>
                <div>
                    <h3 class="text-white font-serif font-bold text-lg mb-4">Navigasi</h3>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" onclick="app.navigate('dashboard')" class="hover:text-blue-400 transition-colors inline-block py-1">Dashboard</a></li>
                        <li><a href="#" onclick="app.navigate('portofolio')" class="hover:text-blue-400 transition-colors inline-block py-1">Kegiatan</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-white font-serif font-bold text-lg mb-4">Sosial Media</h3>
                    <div class="flex justify-center md:justify-start space-x-4">
                        <a href="#" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center hover:bg-emerald-600 hover:text-white transition-all hover:scale-110"><i class="fab fa-whatsapp text-lg"></i></a>
                        <a href="#" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center hover:bg-pink-600 hover:text-white transition-all hover:scale-110"><i class="fab fa-instagram text-lg"></i></a>
                        <a href="#" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center hover:bg-blue-600 hover:text-white transition-all hover:scale-110"><i class="fab fa-facebook text-lg"></i></a>
                    </div>
                </div>
            </div>
            <div class="border-t border-slate-800 mt-10 pt-8 text-xs text-center text-slate-600">
                &copy; 2026 Masjid Jami' Daarul Muttaqin. Dilindungi Undang-Undang.
            </div>
        </div>
    </footer>



    <!-- MAIN JAVASCRIPT LOGIC -->
    <script>
        const CONFIG = {
            // URL Web App Terbaru
            WEB_APP_URL: "https://script.google.com/macros/s/AKfycbxS8VsowU1wExGD8J8iScxLYXjsgx8_59bhh5id6tL3MuVUqk04KKEoTAUaXaDisd8p/exec"
            // ADMIN_PIN sudah dihapus dari sini demi keamanan
        };

        // Variabel untuk menyimpan PIN sementara di memori browser (hilang saat refresh)
        let sessionPin = "";

        const MockData = {
            transactions: [
                { tgl: "2023-12-01", kategori: "Infaq", keterangan: "Contoh: Infaq Jumat (Data Simulasi)", jumlah: 2500000, tipe: 'PEMASUKAN' },
                { tgl: "2023-12-05", kategori: "Operasional", keterangan: "Contoh: Listrik (Data Simulasi)", jumlah: 500000, tipe: 'PENGELUARAN' }
            ],
            activities: [
                { foto: ['https://images.unsplash.com/photo-1609599006353-e629aaabfeae'], nama: 'Contoh Kegiatan', deskripsi: 'Data simulasi.' }
            ]
        };

        const app = {
            data: {
                transactions: [], 
                activities: [],
                totals: { in: 0, out: 0, balance: 0 },
                uniquePeriods: []
            },
            state: {
                currentPage: 1,
                itemsPerPage: 20,
                filteredData: [],
                filterMonth: 'all',
                filterSort: 'newest',
                // New Lightbox State
                lightbox: {
                    photos: [],
                    currentIndex: 0
                }
            },

            init: async function() {
                this.setupNavigation();
                this.setupKeyboardEvents(); // New
                await this.fetchData();
                this.fetchPrayerTimes(); 
                this.renderIslamicHolidays();
                
                // Set default date for transaction form
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('trx-date').value = today;
            },
            
            // Listen for arrow keys in lightbox
            setupKeyboardEvents: function() {
                document.addEventListener('keydown', (e) => {
                    const modal = document.getElementById('modal-lightbox');
                    if (!modal.classList.contains('hidden')) {
                        if (e.key === 'ArrowLeft') this.slideLightbox(-1);
                        if (e.key === 'ArrowRight') this.slideLightbox(1);
                        if (e.key === 'Escape') this.closeModal('modal-lightbox');
                    }
                });
            },

            // --- ADMIN FUNCTIONS ---
            openAdminAuth: function() {
                const modal = document.getElementById('modal-pin');
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }, 10);
                document.getElementById('pin-input').value = '';
                document.getElementById('pin-input').focus();
            },

            // UPDATE: Verifikasi PIN ke Server dengan Error Handling Lebih Detail
            verifyPin: async function() {
                const input = document.getElementById('pin-input').value;
                const btn = document.querySelector('#modal-pin button:last-child'); // Tombol Masuk
                const originalText = btn.innerText;

                if (!input) {
                    this.showToast('Masukkan PIN terlebih dahulu', 'warning');
                    return;
                }

                // UI Loading
                btn.innerText = 'Mengecek...';
                btn.disabled = true;

                try {
                    // Kirim PIN ke Apps Script untuk dicek
                    const response = await fetch(CONFIG.WEB_APP_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ type: 'verify', pin: input })
                    });

                    if (!response.ok) throw new Error("Gagal menghubungi server");
                    
                    const result = await response.json();

                    if (result.ok) {
                        // PIN Benar
                        sessionPin = input; // Simpan di memori sementara
                        this.closeModal('modal-pin');
                        this.showToast("Login Admin Berhasil", "success");
                        this.openTransactionModal();
                    } else {
                        // PIN Salah atau Error Lain
                        const errorMsg = result.error === "Unknown type" 
                            ? "Server belum update (Lakukan Deploy New Version)" 
                            : (result.error || 'PIN Salah! Akses ditolak.');
                            
                        this.showToast(errorMsg, 'error');
                        document.getElementById('pin-input').value = '';
                    }
                } catch (error) {
                    console.error(error);
                    this.showToast('Terjadi kesalahan koneksi.', 'error');
                } finally {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            },

            openTransactionModal: function() {
                const modal = document.getElementById('modal-transaction');
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); }, 10);
            },

            // --- LIGHTBOX (POPUP FOTO) - LOGIC ---
            
            // Helper to get photos array for an activity
            getPhotos: function(item) {
                let photos = [];
                if (Array.isArray(item.foto)) {
                    photos = item.foto;
                } else if (typeof item.foto === 'string' && item.foto.trim() !== '') {
                    photos = item.foto.split(',').map(url => url.trim()).filter(url => url !== '');
                }
                return photos;
            },

            openLightbox: function(actIdx, photoIdx) {
                const item = this.data.activities[actIdx];
                const photos = this.getPhotos(item);
                
                if (photos.length === 0) return;

                // Set State
                this.state.lightbox.photos = photos;
                this.state.lightbox.currentIndex = photoIdx;

                // Render UI
                this.updateLightboxUI();

                // Open Modal Animation
                const modal = document.getElementById('modal-lightbox');
                modal.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    document.getElementById('lightbox-img').classList.remove('scale-95');
                    document.getElementById('lightbox-img').classList.add('scale-100');
                });
            },

            slideLightbox: function(direction) {
                const { photos, currentIndex } = this.state.lightbox;
                if (photos.length <= 1) return;

                let newIndex = currentIndex + direction;
                if (newIndex < 0) newIndex = photos.length - 1; // Loop back to last
                if (newIndex >= photos.length) newIndex = 0; // Loop back to first
                
                this.state.lightbox.currentIndex = newIndex;
                this.updateLightboxUI();
            },

            updateLightboxUI: function() {
                const { photos, currentIndex } = this.state.lightbox;
                const img = document.getElementById('lightbox-img');
                const btnPrev = document.getElementById('lb-prev');
                const btnNext = document.getElementById('lb-next');
                const counter = document.getElementById('lb-counter');

                // Update Image Src
                img.src = photos[currentIndex];
                
                // Toggle Buttons Visibility
                if (photos.length > 1) {
                    btnPrev.classList.remove('hidden');
                    btnNext.classList.remove('hidden');
                    counter.classList.remove('hidden');
                    counter.innerText = `${currentIndex + 1} / ${photos.length}`;
                } else {
                    btnPrev.classList.add('hidden');
                    btnNext.classList.add('hidden');
                    counter.classList.add('hidden');
                }
            },

            closeModal: function(modalId) {
                const modal = document.getElementById(modalId);
                
                if (modalId === 'modal-lightbox') {
                    const img = document.getElementById('lightbox-img');
                    img.classList.remove('scale-100');
                    img.classList.add('scale-95');
                }

                modal.classList.add('opacity-0');
                
                const innerDiv = modal.querySelector('div:not(.relative)'); 
                if (innerDiv) {
                    innerDiv.classList.add('scale-95');
                }
                
                setTimeout(() => { modal.classList.add('hidden'); }, 300);
            },

            submitTransaction: async function(e) {
                e.preventDefault();
                const btn = document.getElementById('btn-save-trx');
                const originalText = btn.innerHTML;
                
                if (!sessionPin) {
                    this.showToast("Sesi habis. Silakan login ulang.", "error");
                    this.closeModal('modal-transaction');
                    return;
                }

                const formData = {
                    type: 'transaction',
                    pin: sessionPin, // Kirim PIN untuk validasi server
                    tipe: document.querySelector('input[name="tipe"]:checked').value,
                    date: document.getElementById('trx-date').value,
                    category: document.getElementById('trx-category').value,
                    amount: document.getElementById('trx-amount').value,
                    desc: document.getElementById('trx-desc').value
                };

                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Menyimpan...';
                btn.disabled = true;

                try {
                    const response = await fetch(CONFIG.WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Mode no-cors agar tidak error block, tapi kita tidak bisa baca response
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(formData)
                    });

                    // Karena no-cors, kita asumsikan berhasil jika tidak ada network error
                    this.showToast("Transaksi berhasil dikirim ke server!");
                    document.getElementById('transaction-form').reset();
                    document.getElementById('trx-date').valueAsDate = new Date(); 
                    this.closeModal('modal-transaction');
                    
                    // Refresh Data setelah jeda
                    setTimeout(() => this.fetchData(), 2500); 
                    
                } catch (err) {
                    this.showToast("Gagal menyimpan transaksi.", "error");
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            },

            // --- JADWAL SHOLAT API ---
            fetchPrayerTimes: async function() {
                const container = document.getElementById('prayer-times-container');
                const dateDisplay = document.getElementById('prayer-date-display');
                
                try {
                    const response = await fetch('https://api.aladhan.com/v1/timingsByCity?city=Kendal&country=Indonesia&method=20');
                    const result = await response.json();

                    if(result.code === 200) {
                        const timings = result.data.timings;
                        const date = result.data.date.readable;
                        dateDisplay.innerText = date;
                        
                        const prayers = [
                            { name: 'Subuh', time: timings.Fajr },
                            { name: 'Dzuhur', time: timings.Dhuhr },
                            { name: 'Ashar', time: timings.Asr },
                            { name: 'Maghrib', time: timings.Maghrib },
                            { name: 'Isya', time: timings.Isha }
                        ];

                        let html = '';
                        prayers.forEach(p => {
                            html += `
                            <div class="flex flex-col items-center justify-center p-4 rounded-xl bg-white/10 backdrop-blur-sm border border-white/20 hover:bg-white/20 transition-all duration-300 group shadow-sm hover:-translate-y-1">
                                <span class="text-[10px] md:text-xs font-bold text-emerald-300 uppercase tracking-widest mb-1 group-hover:text-emerald-200 transition-colors">${p.name}</span>
                                <span class="text-2xl md:text-3xl font-serif font-bold text-white tracking-wide">${p.time}</span>
                            </div>`;
                        });
                        container.innerHTML = html;
                    }
                } catch (e) {
                    container.innerHTML = `<div class="col-span-full text-center text-red-200 text-sm">Gagal memuat jadwal.</div>`;
                }
            },

            // --- AUTO ISLAMIC HOLIDAYS ---
            renderIslamicHolidays: function() {
                const container = document.getElementById('islamic-holidays-container');
                const yearDisplay = document.getElementById('current-year-display');
                const today = new Date();
                const currentYear = today.getFullYear();
                yearDisplay.innerText = currentYear;

                const targetHolidays = [
                    { name: "Tahun Baru Islam", month: 1, day: 1, hijriName: "1 Muharram" },
                    { name: "Maulid Nabi", month: 3, day: 12, hijriName: "12 Rabiul Awal" },
                    { name: "Isra Mi'raj", month: 7, day: 27, hijriName: "27 Rajab" },
                    { name: "Awal Ramadhan", month: 9, day: 1, hijriName: "1 Ramadhan" },
                    { name: "Idul Fitri", month: 10, day: 1, hijriName: "1 Syawal" },
                    { name: "Idul Adha", month: 12, day: 10, hijriName: "10 Dzulhijjah" }
                ];

                const holidayMap = {}; 
                const hijriFormatter = new Intl.DateTimeFormat('en-u-ca-islamic-umalqura', { day: 'numeric', month: 'numeric', year: 'numeric' });
                
                let date = new Date(currentYear, 0, 1);
                const endYear = new Date(currentYear + 1, 0, 1);
                
                while (date < endYear) {
                    const parts = hijriFormatter.formatToParts(date);
                    const hMonth = parseInt(parts.find(p => p.type === 'month').value);
                    const hDay = parseInt(parts.find(p => p.type === 'day').value);
                    const hYear = parts.find(p => p.type === 'year').value;

                    targetHolidays.forEach(target => {
                        if (target.month === hMonth && target.day === hDay) {
                            const key = target.name + hYear;
                            if (!holidayMap[key]) {
                                holidayMap[key] = {
                                    name: target.name,
                                    hijriDate: `${target.hijriName} ${hYear} H`,
                                    gregorianDate: new Date(date)
                                };
                            }
                        }
                    });
                    date.setDate(date.getDate() + 1);
                }

                const sortedHolidays = Object.values(holidayMap).sort((a, b) => a.gregorianDate - b.gregorianDate);
                let html = '';
                const monthNames = ["JAN", "FEB", "MAR", "APR", "MEI", "JUN", "JUL", "AGT", "SEP", "OKT", "NOV", "DES"];

                if (sortedHolidays.length === 0) {
                    html = '<div class="col-span-full text-center text-slate-400">Tidak ada data hari besar ditemukan.</div>';
                } else {
                    sortedHolidays.forEach(h => {
                        const d = h.gregorianDate;
                        html += `
                        <div class="flex items-start p-3 rounded-lg bg-emerald-50 border border-emerald-100 hover:shadow-sm transition">
                            <div class="bg-emerald-200 text-emerald-800 font-bold rounded-lg w-12 h-12 flex items-center justify-center flex-shrink-0 mr-3 border border-emerald-300">
                                <span class="text-xs text-center leading-tight">${monthNames[d.getMonth()]}<br>${d.getDate()}</span>
                            </div>
                            <div>
                                <h4 class="font-bold text-emerald-900 text-sm">${h.name}</h4>
                                <p class="text-xs text-emerald-700">${h.hijriDate}</p>
                            </div>
                        </div>`;
                    });
                }
                container.innerHTML = html;
            },

            // --- DATA UTAMA (SHEETS) ---
            fetchData: async function() {
                const loader = document.getElementById('loading-state');
                const errorState = document.getElementById('error-state');
                
                loader.classList.remove('hidden');
                errorState.classList.add('hidden');

                try {
                    const urlTrans = `${CONFIG.WEB_APP_URL}?action=gettransactions&t=${Date.now()}`;
                    const urlAct = `${CONFIG.WEB_APP_URL}?action=getactivities&t=${Date.now()}`;

                    const fetchSafe = async (url) => {
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const text = await response.text();
                        try { return JSON.parse(text); } catch (e) { throw new Error("Respon server tidak valid"); }
                    };

                    const [transJson, actJson] = await Promise.all([ fetchSafe(urlTrans), fetchSafe(urlAct) ]);

                    if (transJson.ok) {
                         app.processData(transJson.data);
                    } else {
                         throw new Error(transJson.error || "Gagal memuat transaksi");
                    }

                    if (actJson.ok) {
                        app.data.activities = actJson.data;
                    } else {
                        console.warn("Gagal memuat kegiatan:", actJson.error);
                        app.data.activities = [];
                    }
                    
                    app.renderAll();
                    loader.classList.add('hidden');
                    
                    const now = new Date();
                    document.getElementById('last-updated').innerHTML = `<i class="fas fa-check-circle text-emerald-500 mr-1"></i> Data Asli - Diperbarui: ${now.toLocaleTimeString('id-ID')}`;

                } catch (error) {
                    console.warn("Error Detail:", error);
                    app.processData(MockData.transactions); 
                    app.data.activities = MockData.activities;
                    app.renderAll();
                    loader.classList.add('hidden');
                    let errorMsg = "Gagal koneksi. Menggunakan Data Simulasi.";
                    app.showToast(errorMsg, "warning");
                    document.getElementById('last-updated').innerHTML = `<i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i> Mode Simulasi (Offline)`;
                }
            },

            processData: function(rawTransactions) {
                if (!rawTransactions) return; 
                const periods = new Set();
                app.data.transactions = rawTransactions.map(item => {
                    const tgl = item.tanggal || item.tgl || item.date || ""; 
                    const kat = item.kategori || item.category || "";
                    const ket = item.keterangan || item.desc || "";
                    const jum = (item.jumlah !== undefined && item.jumlah !== "") ? item.jumlah : 
                                (item.amount !== undefined && item.amount !== "") ? item.amount : 0;
                    const tipeRaw = item.tipe || item.type || "";

                    const tipeStr = (tipeRaw || '').toUpperCase();
                    const isMasuk = tipeStr.includes('MASUK') || tipeStr.includes('IN') || tipeStr === 'PEMASUKAN' || tipeStr === 'INFAQ';
                    
                    if (tgl && tgl.length >= 7) {
                        periods.add(tgl.substring(0, 7)); 
                    }

                    return {
                        date: tgl,            
                        category: kat,   
                        desc: ket,     
                        amount: parseInt(jum) || 0, 
                        type: isMasuk ? 'in' : 'out',
                        originalType: tipeRaw
                    };
                });

                app.data.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                app.data.totals.in = app.data.transactions.filter(t => t.type === 'in').reduce((sum, item) => sum + item.amount, 0);
                app.data.totals.out = app.data.transactions.filter(t => t.type === 'out').reduce((sum, item) => sum + item.amount, 0);
                app.data.totals.balance = app.data.totals.in - app.data.totals.out;

                app.data.uniquePeriods = Array.from(periods).sort().reverse();
                const monthSelect = document.getElementById('filter-month');
                monthSelect.innerHTML = '<option value="all">Semua Periode</option>';
                app.data.uniquePeriods.forEach(ym => {
                    const [year, month] = ym.split('-');
                    const date = new Date(year, month - 1);
                    const label = date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                    monthSelect.innerHTML += `<option value="${ym}">${label}</option>`;
                });
            },

            renderAll: function() {
                app.renderSummary();
                app.handleFilterChange();
                app.renderPortfolio();
            },

            renderSummary: function() {
                document.getElementById('dash-total-in').innerText = app.formatCurrency(app.data.totals.in);
                document.getElementById('dash-total-out').innerText = app.formatCurrency(app.data.totals.out);
                document.getElementById('dash-balance').innerText = app.formatCurrency(app.data.totals.balance);
            },

            handleFilterChange: function() {
                app.state.filterMonth = document.getElementById('filter-month').value;
                app.state.filterSort = document.getElementById('filter-sort').value;
                app.state.currentPage = 1;

                app.state.filteredData = app.data.transactions.filter(t => {
                    if (app.state.filterMonth === 'all') return true;
                    // Pastikan t.date ada sebelum dicek
                    return t.date && t.date.startsWith(app.state.filterMonth);
                });

                app.state.filteredData.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    if(isNaN(dateA)) return 1; 
                    if(isNaN(dateB)) return -1;
                    
                    return app.state.filterSort === 'newest' ? dateB - dateA : dateA - dateB;
                });

                app.renderTable();
            },

            renderTable: function() {
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '';
                const start = (app.state.currentPage - 1) * app.state.itemsPerPage;
                const end = start + app.state.itemsPerPage;
                const pageData = app.state.filteredData.slice(start, end);
                const totalItems = app.state.filteredData.length;

                if (totalItems === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400 italic bg-slate-50/50">Tidak ada data untuk periode ini.</td></tr>';
                    document.getElementById('pagination-info').innerText = '0 data';
                    document.getElementById('btn-prev').disabled = true;
                    document.getElementById('btn-next').disabled = true;
                    return;
                }

                pageData.forEach(t => {
                    const amountIn = t.type === 'in' ? app.formatCurrency(t.amount) : '-';
                    const amountOut = t.type === 'out' ? app.formatCurrency(t.amount) : '-';
                    const row = `
                        <tr class="bg-white border-b hover:bg-slate-50 transition duration-150">
                            <td class="px-6 py-4 whitespace-nowrap text-slate-700 font-medium">${app.formatDate(t.date)}</td>
                            <td class="px-6 py-4 whitespace-nowrap"><span class="px-3 py-1 rounded-full text-xs font-bold ${t.type === 'in' ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800'}">${t.category || ""}</span></td>
                            <td class="px-6 py-4 text-slate-600">${t.desc}</td>
                            <td class="px-6 py-4 text-right font-bold text-emerald-600 whitespace-nowrap">${amountIn}</td>
                            <td class="px-6 py-4 text-right font-bold text-rose-600 whitespace-nowrap">${amountOut}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                document.getElementById('pagination-info').innerText = `Menampilkan ${start + 1} - ${Math.min(end, totalItems)} dari ${totalItems} data`;
                document.getElementById('btn-prev').disabled = app.state.currentPage === 1;
                document.getElementById('btn-next').disabled = end >= totalItems;
            },

            nextPage: function() {
                if ((app.state.currentPage * app.state.itemsPerPage) < app.state.filteredData.length) {
                    app.state.currentPage++;
                    app.renderTable();
                    document.getElementById('transaction-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            },

            prevPage: function() {
                if (app.state.currentPage > 1) {
                    app.state.currentPage--;
                    app.renderTable();
                    document.getElementById('transaction-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            },

            renderPortfolio: function() {
                const container = document.getElementById('portfolio-grid');
                container.innerHTML = ''; 
                if (!app.data.activities || app.data.activities.length === 0) {
                    container.innerHTML = `<div class="col-span-full text-center py-12 bg-white rounded-xl border-2 border-dashed border-slate-300">...</div>`;
                    return;
                }
                app.data.activities.forEach((item, index) => {
                    const photos = app.getPhotos(item);
                    const hasPhotos = photos.length > 0;
                    const activityId = `activity-${index}`;
                    let mediaElement;
                    if (hasPhotos) {
                        if (photos.length > 1) {
                            let slidesHtml = '';
                            photos.forEach((url, pIndex) => {
                                slidesHtml += `
                                    <div class="flex-shrink-0 w-full h-full snap-center bg-slate-100 relative cursor-pointer" onclick="app.openLightbox(${index}, ${pIndex})">
                                        <img src="${url}" class="w-full h-full object-cover" loading="lazy" onerror="this.src='https://via.placeholder.com/400x300?text=Gagal+Memuat'">
                                    </div>
                                `;
                            });
                            mediaElement = `
                                <div class="relative group h-48">
                                    <div id="${activityId}" class="h-full overflow-x-auto flex snap-x snap-mandatory no-scrollbar scroll-smooth">
                                        ${slidesHtml}
                                    </div>
                                    <button onclick="app.scrollSlider('${activityId}', -1)" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/30 hover:bg-black/50 text-white rounded-full p-1.5 backdrop-blur-sm transition-opacity opacity-0 group-hover:opacity-100 z-20 cursor-pointer"><i class="fas fa-chevron-left"></i></button>
                                    <button onclick="app.scrollSlider('${activityId}', 1)" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/30 hover:bg-black/50 text-white rounded-full p-1.5 backdrop-blur-sm transition-opacity opacity-0 group-hover:opacity-100 z-20 cursor-pointer"><i class="fas fa-chevron-right"></i></button>
                                    <div class="absolute bottom-2 right-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded-md backdrop-blur-sm pointer-events-none z-20"><i class="fas fa-images mr-1"></i> ${photos.length} Foto</div>
                                </div>
                            `;
                        } else {
                            mediaElement = `
                                <div class="h-48 overflow-hidden bg-slate-100 relative group cursor-pointer" onclick="app.openLightbox(${index}, 0)">
                                    <img src="${photos[0]}" alt="${item.nama || ''}" class="w-full h-full object-cover transform group-hover:scale-110 transition duration-700" onerror="this.parentElement.innerHTML='...';">
                                </div>
                            `;
                        }
                    } else {
                        mediaElement = `<div class="h-48 overflow-hidden bg-slate-100 flex flex-col items-center justify-center text-slate-400"><i class="far fa-image text-3xl mb-2"></i><span class="text-xs">Tidak ada foto</span></div>`;
                    }
                    container.innerHTML += `<div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-lg transition-all duration-300">${mediaElement}<div class="p-6"><div class="flex items-center justify-between text-xs text-slate-400 mb-2.5"><span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide">Kegiatan</span><span>${app.formatDate(item.date)}</span></div><h3 class="font-serif font-bold text-lg text-slate-800 mb-2 leading-tight">${item.nama || "(Tanpa Nama)"}</h3>${item.deskripsi ? `<p class="text-sm text-slate-600 line-clamp-3 leading-relaxed">${item.deskripsi}</p>` : ''}</div></div>`;
                });
            },
            
            scrollSlider: function(elementId, direction) {
                const container = document.getElementById(elementId);
                if (container) {
                    const scrollAmount = container.clientWidth;
                    container.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
                }
            },

            navigate: function(targetId) {
                document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(btn => {
                    const isActive = btn.dataset.target === targetId;
                    if(btn.classList.contains('nav-btn')) {
                        btn.classList.toggle('bg-blue-700', isActive);
                        btn.classList.toggle('shadow-sm', isActive);
                        btn.classList.toggle('text-white', isActive);
                        if(!isActive) { btn.classList.remove('bg-blue-700', 'shadow-sm'); btn.classList.add('text-blue-100'); } else { btn.classList.remove('text-blue-100'); }
                    }
                });
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${targetId}`).classList.remove('hidden');
                document.getElementById('mobile-menu').classList.add('hidden');
                window.scrollTo(0, 0);
            },

            toggleMobileMenu: function() {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            },

            // FIX: HITUNG TOTAL BERDASARKAN DATA TAMPIL & NAMA MASJID
            exportToPDF: function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const monthSelect = document.getElementById('filter-month');
                const period = monthSelect.options[monthSelect.selectedIndex].text;
                
                // 1. HITUNG TOTAL DARI DATA YANG TAMPIL (FILTERED)
                let currentTotalIn = 0;
                let currentTotalOut = 0;
                
                app.state.filteredData.forEach(t => {
                    if (t.type === 'in') currentTotalIn += t.amount;
                    if (t.type === 'out') currentTotalOut += t.amount;
                });
                
                const currentDiff = currentTotalIn - currentTotalOut;

                doc.setFillColor(30, 64, 175);
                doc.rect(0, 0, 210, 28, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                // 2. NAMA MASJID PERMANEN
                doc.text("LAPORAN KAS Masjid Jami' Daarul Muttaqin", 105, 14, null, null, "center");
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text("Bulusari - Limbangan, Kendal", 105, 20, null, null, "center");
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.text(`Periode: ${period}`, 14, 38);
                doc.text(`Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}`, 14, 43);

                const tableData = app.state.filteredData.map(t => [
                    app.formatDate(t.date),
                    t.category,
                    t.desc,
                    t.type === 'in' ? app.formatCurrency(t.amount) : '-',
                    t.type === 'out' ? app.formatCurrency(t.amount) : '-'
                ]);

                doc.autoTable({ startY: 48, head: [['Tanggal', 'Kategori', 'Keterangan', 'Masuk', 'Keluar']], body: tableData, theme: 'grid' });
                
                const finalY = doc.lastAutoTable.finalY + 10;
                
                // 3. TAMPILKAN TOTAL YANG SUDAH DIHITUNG
                doc.text("Total Pemasukan:", 120, finalY + 4); 
                doc.text(app.formatCurrency(currentTotalIn), 195, finalY + 4, null, null, "right");
                
                doc.text("Total Pengeluaran:", 120, finalY + 9); 
                doc.text(app.formatCurrency(currentTotalOut), 195, finalY + 9, null, null, "right");
                
                doc.setFillColor(240, 249, 255); doc.rect(115, finalY + 13, 85, 10, 'F');
                doc.setFont(undefined, 'bold'); doc.setTextColor(30, 64, 175); 
                
                const labelSaldo = period === 'Semua Periode' ? 'Saldo Akhir:' : 'Surplus/Defisit:';
                doc.text(labelSaldo, 120, finalY + 20); 
                doc.text(app.formatCurrency(currentDiff), 195, finalY + 20, null, null, "right");
                
                doc.save(`Laporan_Kas_${period}.pdf`);
            },

            formatCurrency: function(num) {
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
            },
            formatDate: function(dateString) {
                if(!dateString) return '-';
                return new Date(dateString).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
            },
            
            showToast: function(message, type = 'success') {
                // ... (Toast logic same as before) ...
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg mb-3 transition transform translate-x-full duration-300 flex items-center pointer-events-auto`;
                if(type === 'warning') toast.className = `bg-yellow-500 text-white px-6 py-3 rounded-lg shadow-lg mb-3 transition transform translate-x-full duration-300 flex items-center pointer-events-auto`;
                if(type === 'error') toast.className = `bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg mb-3 transition transform translate-x-full duration-300 flex items-center pointer-events-auto`;
                toast.innerHTML = `<i class="fas fa-info-circle mr-3"></i> ${message}`;
                container.appendChild(toast);
                setTimeout(() => toast.classList.remove('translate-x-full'), 10);
                setTimeout(() => { toast.classList.add('translate-x-full', 'opacity-0'); setTimeout(() => toast.remove(), 300); }, 3000);
            },

            submitFeedback: async function(e) {
                e.preventDefault();
                // ... (Feedback logic same as before) ...
                const btn = document.getElementById('btn-submit');
                const originalText = btn.innerHTML;
                btn.innerHTML = 'Mengirim...'; btn.disabled = true;
                try {
                    await fetch(CONFIG.WEB_APP_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type: 'feedback', name: document.getElementById('feedback-name').value, message: document.getElementById('feedback-message').value }) });
                    this.showToast("Terima kasih! Masukan Anda telah diterima.");
                    document.getElementById('feedback-form').reset();
                } catch (err) { this.showToast("Gagal mengirim pesan.", "error"); } finally { btn.innerHTML = originalText; btn.disabled = false; }
            }
        };
        
        app.setupNavigation = function() { };

        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
