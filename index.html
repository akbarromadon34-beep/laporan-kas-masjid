<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kas Masjid</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    * {
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .gradient-bg {
      background: linear-gradient(135deg, #0d9488 0%, #065f46 50%, #064e3b 100%);
    }
    .pattern-overlay {
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M30 0L60 30L30 60L0 30z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    .table-row-hover:hover {
      background-color: #f0fdf4;
    }
    .income-badge {
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      color: #166534;
    }
    .expense-badge {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
    .animate-delay-1 { animation-delay: 0.1s; }
    .animate-delay-2 { animation-delay: 0.2s; }
    .animate-delay-3 { animation-delay: 0.3s; }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .animate-pulse {
      animation: pulse 2s ease-in-out infinite;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full gradient-bg pattern-overlay">
  <div class="min-h-full w-full overflow-auto">
   <div class="max-w-6xl mx-auto px-4 py-1"><!-- Header -->
    <header class="text-center mb-2 opacity-0 animate-fade-in">
     <div class="inline-flex items-center justify-center w-12 h-12 bg-white/20 rounded-xl mb-2">
      <svg class="w-8 h-8 text-white" fill="currentColor" viewbox="0 0 24 24"><path d="M12 2L2 8.5V22h20V8.5L12 2zm0 2.31l7 4.5V20H5V8.81l7-4.5zM12 6a1 1 0 100 2 1 1 0 000-2zm-3 5v6h2v-6H9zm4 0v6h2v-6h-2z" />
      </svg>
     </div>
     <h1 id="mosque-name" class="text-2xl md:text-3xl font-bold text-white mb-0">Kas Masjid Al-Ikhlas</h1><!-- Sync Status -->
     <div id="sync-status" class="inline-flex items-center gap-2 px-4 py-2 bg-white/10 rounded-full text-white/80 text-sm mt-2">
      <svg id="sync-icon" class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg><span id="sync-text">Menghubungkan ke Google Sheet...</span>
     </div>
    </header><!-- Mosque Illustration & Report Title -->
    <div class="glass-card rounded-2xl shadow-xl mb-4 overflow-hidden opacity-0 animate-fade-in animate-delay-1"><!-- Mosque SVG Illustration -->
     <div class="relative bg-gradient-to-b from-teal-600 via-teal-700 to-emerald-800 p-4 pb-8"><!-- Sky decorations -->
      <div class="absolute top-4 left-8 w-2 h-2 bg-yellow-300 rounded-full animate-pulse"></div>
      <div class="absolute top-8 left-20 w-1.5 h-1.5 bg-yellow-200 rounded-full animate-pulse" style="animation-delay: 0.5s"></div>
      <div class="absolute top-6 right-16 w-2 h-2 bg-yellow-300 rounded-full animate-pulse" style="animation-delay: 0.3s"></div>
      <div class="absolute top-10 right-32 w-1.5 h-1.5 bg-yellow-200 rounded-full animate-pulse" style="animation-delay: 0.7s"></div><!-- Moon -->
      <div class="absolute top-4 right-8 w-12 h-12 bg-gradient-to-br from-yellow-200 to-yellow-400 rounded-full shadow-lg shadow-yellow-400/30">
       <div class="absolute top-1 right-1 w-10 h-10 bg-gradient-to-b from-teal-600 to-teal-700 rounded-full"></div>
      </div><!-- Mosque SVG -->
      <svg class="w-full h-48 md:h-64" viewbox="0 0 800 300" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse cx="400" cy="120" rx="120" ry="80" fill="url(#domeGradient)" /> <ellipse cx="400" cy="120" rx="100" ry="65" fill="url(#domeInnerGradient)" /> <g transform="translate(400, 45)">
        <circle cx="0" cy="0" r="12" fill="#FFD700" />
        <circle cx="4" cy="0" r="10" fill="url(#domeGradient)" />
        <rect x="-2" y="12" width="4" height="15" fill="#FFD700" />
       </g> <rect x="180" y="100" width="40" height="180" fill="url(#minaretGradient)" /> <polygon points="200,40 230,100 170,100" fill="url(#roofGradient)" /> <circle cx="200" cy="35" r="8" fill="#FFD700" /> <rect x="198" y="20" width="4" height="10" fill="#FFD700" /> <rect x="185" y="130" width="30" height="20" fill="#1e3a5f" rx="10" ry="10" /> <rect x="185" y="180" width="30" height="20" fill="#1e3a5f" rx="10" ry="10" /> <rect x="185" y="230" width="30" height="20" fill="#1e3a5f" rx="10" ry="10" /> <rect x="580" y="100" width="40" height="180" fill="url(#minaretGradient)" /> <polygon points="600,40 630,100 570,100" fill="url(#roofGradient)" /> <circle cx="600" cy="35" r="8" fill="#FFD700" /> <rect x="598" y="20" width="4" height="10" fill="#FFD700" /> <rect x="585" y="130" width="30" height="20" fill="#1e3a5f" rx="10" ry="10" /> <rect x="585" y="180" width="30" height="20" fill="#1e3a5f" rx="10" ry="10" /> <rect x="585" y="230" width="30" height="20" fill="#1e3a5f" rx="10" ry="10" /> <rect x="250" y="140" width="300" height="140" fill="url(#buildingGradient)" /> <rect x="350" y="180" width="100" height="100" fill="#1e3a5f" rx="50" ry="50" /> <rect x="360" y="200" width="80" height="80" fill="#0f2942" rx="40" ry="40" /> <rect x="395" y="220" width="10" height="60" fill="#FFD700" /> <rect x="270" y="180" width="50" height="70" fill="#1e3a5f" rx="25" ry="25" /> <rect x="280" y="190" width="30" height="50" fill="#0f2942" rx="15" ry="15" /> <rect x="480" y="180" width="50" height="70" fill="#1e3a5f" rx="25" ry="25" /> <rect x="490" y="190" width="30" height="50" fill="#0f2942" rx="15" ry="15" /> <ellipse cx="300" cy="145" rx="40" ry="30" fill="url(#smallDomeGradient)" /> <circle cx="300" cy="112" r="5" fill="#FFD700" /> <rect x="298" y="102" width="4" height="8" fill="#FFD700" /> <ellipse cx="500" cy="145" rx="40" ry="30" fill="url(#smallDomeGradient)" /> <circle cx="500" cy="112" r="5" fill="#FFD700" /> <rect x="498" y="102" width="4" height="8" fill="#FFD700" /> <rect x="160" y="280" width="480" height="20" fill="url(#baseGradient)" /> <rect x="250" y="140" width="300" height="8" fill="#FFD700" opacity="0.6" /> <rect x="180" y="100" width="40" height="5" fill="#FFD700" opacity="0.6" /> <rect x="580" y="100" width="40" height="5" fill="#FFD700" opacity="0.6" /> <defs>
        <lineargradient id="domeGradient" x1="0%" y1="0%" x2="0%" y2="100%">
         <stop offset="0%" style="stop-color:#34d399" />
         <stop offset="100%" style="stop-color:#059669" />
        </lineargradient>
        <lineargradient id="domeInnerGradient" x1="0%" y1="0%" x2="0%" y2="100%">
         <stop offset="0%" style="stop-color:#10b981" />
         <stop offset="100%" style="stop-color:#047857" />
        </lineargradient>
        <lineargradient id="smallDomeGradient" x1="0%" y1="0%" x2="0%" y2="100%">
         <stop offset="0%" style="stop-color:#6ee7b7" />
         <stop offset="100%" style="stop-color:#34d399" />
        </lineargradient>
        <lineargradient id="minaretGradient" x1="0%" y1="0%" x2="100%" y2="0%">
         <stop offset="0%" style="stop-color:#f5f5f4" />
         <stop offset="50%" style="stop-color:#ffffff" />
         <stop offset="100%" style="stop-color:#e7e5e4" />
        </lineargradient>
        <lineargradient id="buildingGradient" x1="0%" y1="0%" x2="100%" y2="0%">
         <stop offset="0%" style="stop-color:#fafaf9" />
         <stop offset="50%" style="stop-color:#ffffff" />
         <stop offset="100%" style="stop-color:#f5f5f4" />
        </lineargradient>
        <lineargradient id="roofGradient" x1="0%" y1="0%" x2="0%" y2="100%">
         <stop offset="0%" style="stop-color:#34d399" />
         <stop offset="100%" style="stop-color:#10b981" />
        </lineargradient>
        <lineargradient id="baseGradient" x1="0%" y1="0%" x2="0%" y2="100%">
         <stop offset="0%" style="stop-color:#d6d3d1" />
         <stop offset="100%" style="stop-color:#a8a29e" />
        </lineargradient>
       </defs>
      </svg>
     </div><!-- Report Title -->
     <div class="bg-gradient-to-r from-emerald-700 via-teal-600 to-emerald-700 py-5 px-6 text-center">
      <h2 id="report-title-display" class="text-xl md:text-2xl font-bold text-white tracking-wide drop-shadow-lg">LAPORAN KAS MASJID JAMI' DAARUL MUTTAQIN</h2>
      <p class="text-teal-100 text-sm mt-1">Data tersinkron dari Google Sheet</p>
     </div>
    </div><!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
     <div class="rounded-2xl p-6 shadow-xl opacity-0 animate-fade-in animate-delay-1 bg-gradient-to-br from-emerald-500 to-green-600 text-white relative overflow-hidden">
      <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
      <div class="absolute bottom-0 left-0 w-20 h-20 bg-white/10 rounded-full translate-y-1/2 -translate-x-1/2"></div>
      <div class="relative z-10">
       <div class="flex items-center gap-3 mb-3">
        <div class="w-12 h-12 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center">
         <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12" />
         </svg>
        </div><span class="text-white/80 font-medium">Total Pemasukan</span>
       </div>
       <p id="total-income" class="text-3xl font-bold text-white">-</p>
      </div>
     </div>
     <div class="rounded-2xl p-6 shadow-xl opacity-0 animate-fade-in animate-delay-2 bg-gradient-to-br from-rose-500 to-red-600 text-white relative overflow-hidden">
      <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
      <div class="absolute bottom-0 left-0 w-20 h-20 bg-white/10 rounded-full translate-y-1/2 -translate-x-1/2"></div>
      <div class="relative z-10">
       <div class="flex items-center gap-3 mb-3">
        <div class="w-12 h-12 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center">
         <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6" />
         </svg>
        </div><span class="text-white/80 font-medium">Total Pengeluaran</span>
       </div>
       <p id="total-expense" class="text-3xl font-bold text-white">-</p>
      </div>
     </div>
     <div class="rounded-2xl p-6 shadow-xl opacity-0 animate-fade-in animate-delay-3 bg-gradient-to-br from-blue-500 to-indigo-600 text-white relative overflow-hidden">
      <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
      <div class="absolute bottom-0 left-0 w-20 h-20 bg-white/10 rounded-full translate-y-1/2 -translate-x-1/2"></div>
      <div class="relative z-10">
       <div class="flex items-center gap-3 mb-3">
        <div class="w-12 h-12 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center">
         <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
         </svg>
        </div><span class="text-white/80 font-medium">Total Saldo</span>
       </div>
       <p id="total-balance" class="text-3xl font-bold text-white">-</p>
      </div>
     </div>
    </div><!-- Filter & Controls -->
    <div class="glass-card rounded-2xl p-6 shadow-xl mb-6 opacity-0 animate-fade-in animate-delay-3">
     <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-end">
      <div class="flex-1 w-full lg:w-auto"><label for="month-filter" class="block text-gray-600 text-sm font-medium mb-2">Filter Bulan &amp; Tahun</label> <input type="month" id="month-filter" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all outline-none bg-gray-50" placeholder="Pilih bulan">
      </div>
      <div class="flex-1 w-full lg:w-auto"><label for="sort-select" class="block text-gray-600 text-sm font-medium mb-2">Urutkan</label> <select id="sort-select" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all outline-none bg-gray-50 cursor-pointer"> <option value="newest">Terbaru ‚Üí Terlama</option> <option value="oldest">Terlama ‚Üí Terbaru</option> </select>
      </div>
      <div class="flex gap-3 w-full lg:w-auto"><button id="refresh-btn" type="button" class="flex-1 lg:flex-none px-6 py-3 bg-blue-500 text-white font-medium rounded-xl hover:bg-blue-600 transition-all flex items-center justify-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg> Refresh Data </button> <button id="reset-btn" type="button" class="flex-1 lg:flex-none px-6 py-3 bg-gray-100 text-gray-700 font-medium rounded-xl hover:bg-gray-200 transition-all flex items-center justify-center gap-2"> Reset Filter </button> <button id="download-btn" type="button" class="flex-1 lg:flex-none px-6 py-3 bg-teal-600 text-white font-medium rounded-xl hover:bg-teal-700 transition-all flex items-center justify-center gap-2 shadow-lg shadow-teal-600/30">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg> Download PDF </button>
      </div>
     </div>
    </div><!-- Loading State -->
    <div id="loading-state" class="glass-card rounded-2xl shadow-xl p-12 text-center mb-6">
     <div class="w-16 h-16 border-4 border-teal-200 border-t-teal-600 rounded-full animate-spin mx-auto mb-4"></div>
     <p class="text-gray-600 font-medium">Memuat data dari Google Sheet...</p>
     <p class="text-gray-400 text-sm mt-1">Mohon tunggu sebentar</p>
    </div><!-- Error State -->
    <div id="error-state" class="hidden glass-card rounded-2xl shadow-xl p-12 text-center mb-6">
     <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
      <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
     </div>
     <p class="text-gray-800 font-medium mb-2">Gagal memuat data</p>
     <p id="error-message" class="text-gray-500 text-sm mb-4">Terjadi kesalahan saat menghubungi Google Sheet</p><!-- Debug Info -->
     <div id="debug-info" class="text-left bg-gray-100 rounded-lg p-4 mb-4 text-xs font-mono text-gray-600 max-h-40 overflow-auto"></div><button id="retry-btn" type="button" class="px-6 py-2 bg-teal-600 text-white font-medium rounded-xl hover:bg-teal-700 transition-all"> Coba Lagi </button>
    </div><!-- Setup Instructions -->
    <div id="setup-instructions" class="hidden glass-card rounded-2xl shadow-xl p-6 mb-6">
     <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
      <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg> Panduan Setup Google Apps Script</h3>
     <div class="space-y-4 text-sm text-gray-600">
      <p><strong>Pastikan kode Google Apps Script Anda seperti ini:</strong></p>
      <pre class="bg-gray-800 text-green-400 p-4 rounded-lg overflow-x-auto text-xs">function doGet(e) {
  var sheet = SpreadsheetApp.openById('ID_SPREADSHEET_ANDA').getActiveSheet();
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  var result = [];
  
  for (var i = 1; i &lt; data.length; i++) {
    if (data[i][0]) { // Skip empty rows
      result.push({
        tanggal: data[i][0],
        tipe: data[i][1],
        keterangan: data[i][2],
        jumlah: data[i][3]
      });
    }
  }
  
  var output = JSON.stringify({
    status: 'success',
    data: result,
    saldoAwal: 0
  });
  
  return ContentService
    .createTextOutput(output)
    .setMimeType(ContentService.MimeType.JSON);
}</pre>
      <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
       <p class="font-semibold text-amber-800 mb-2">‚ö†Ô∏è Langkah Penting:</p>
       <ol class="list-decimal list-inside space-y-1 text-amber-700">
        <li>Buka menu <strong>Deploy ‚Üí New deployment</strong></li>
        <li>Pilih type: <strong>Web app</strong></li>
        <li>Execute as: <strong>Me</strong></li>
        <li>Who has access: <strong>Anyone</strong></li>
        <li>Klik <strong>Deploy</strong> dan copy URL-nya</li>
       </ol>
      </div>
     </div>
    </div><!-- Data Table -->
    <div id="data-container" class="hidden glass-card rounded-2xl shadow-xl overflow-hidden opacity-0 animate-fade-in animate-delay-3">
     <div class="p-6 border-b border-gray-100">
      <h2 class="text-lg font-semibold text-gray-800">Riwayat Transaksi</h2>
      <p id="filter-info" class="text-sm text-gray-500 mt-1">Menampilkan semua data</p>
     </div>
     <div class="overflow-x-auto">
      <table class="w-full">
       <thead>
        <tr class="bg-gray-50">
         <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Tanggal</th>
         <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Tipe</th>
         <th class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Keterangan</th>
         <th class="px-6 py-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Jumlah</th>
        </tr>
       </thead>
       <tbody id="table-body" class="divide-y divide-gray-100">
       </tbody>
      </table>
     </div>
     <div id="empty-state" class="hidden p-12 text-center">
      <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
       <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
       </svg>
      </div>
      <p class="text-gray-500 font-medium">Tidak ada data untuk ditampilkan</p>
      <p class="text-gray-400 text-sm mt-1">Coba ubah filter atau reset pencarian</p>
     </div>
     <div id="pagination-container" class="p-6 border-t border-gray-100 bg-gray-50">
      <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
       <p id="pagination-info" class="text-sm text-gray-600 font-medium">Menampilkan 0 data</p>
       <div class="flex items-center gap-3"><button id="prev-btn" type="button" class="px-5 py-2.5 bg-white border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-100 hover:border-gray-400 transition-all disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-2 shadow-sm">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
         </svg> Prev </button>
        <div id="page-numbers" class="flex items-center gap-2"></div><button id="next-btn" type="button" class="px-5 py-2.5 bg-teal-600 text-white font-semibold rounded-xl hover:bg-teal-700 transition-all disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-2 shadow-sm shadow-teal-600/30"> Next 
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
         </svg></button>
       </div>
      </div>
     </div>
    </div><!-- Kritik & Saran Section -->
    <div class="glass-card rounded-2xl shadow-xl mt-6 overflow-hidden opacity-0 animate-fade-in animate-delay-3">
     <div class="p-6 border-b border-gray-100 bg-gradient-to-r from-teal-600 to-emerald-600">
      <div class="flex items-center gap-3">
       <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
        </svg>
       </div>
       <div>
        <h2 class="text-lg font-semibold text-white">Kritik &amp; Saran</h2>
        <p class="text-teal-100 text-sm">Sampaikan masukan Anda secara anonim</p>
       </div>
      </div>
     </div>
     <form id="feedback-form" class="p-6 space-y-4">
      <div><label for="feedback-category" class="block text-gray-700 text-sm font-medium mb-2">Kategori</label> <select id="feedback-category" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all outline-none bg-gray-50 cursor-pointer" required> <option value="">Pilih kategori...</option> <option value="Keuangan">Keuangan</option> <option value="Fasilitas">Fasilitas</option> <option value="Kegiatan">Kegiatan</option> <option value="Pelayanan">Pelayanan</option> <option value="Lainnya">Lainnya</option> </select>
      </div>
      <div><label for="feedback-message" class="block text-gray-700 text-sm font-medium mb-2">Pesan Kritik / Saran</label> <textarea id="feedback-message" rows="4" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all outline-none bg-gray-50 resize-none" placeholder="Tulis kritik atau saran Anda di sini..." required></textarea>
      </div>
      <div class="flex items-start gap-3 p-4 bg-blue-50 rounded-xl">
       <svg class="w-5 h-5 text-blue-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
       </svg>
       <p class="text-blue-700 text-sm">Pesan Anda bersifat <strong>anonim</strong> dan akan dikirim ke email pengurus masjid untuk ditindaklanjuti.</p>
      </div><button type="submit" id="submit-feedback-btn" class="w-full px-6 py-3 bg-teal-600 text-white font-medium rounded-xl hover:bg-teal-700 transition-all flex items-center justify-center gap-2 shadow-lg shadow-teal-600/30">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
       </svg> Kirim ke Email Pengurus </button>
     </form>
     <div id="feedback-success" class="hidden p-6 text-center">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
       <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
       </svg>
      </div>
      <h3 class="text-lg font-semibold text-gray-800 mb-2">Terima Kasih!</h3>
      <p class="text-gray-600 text-sm mb-4">Kritik dan saran Anda telah dikirim ke email pengurus masjid.</p><button type="button" id="send-another-btn" class="px-6 py-2 bg-gray-100 text-gray-700 font-medium rounded-xl hover:bg-gray-200 transition-all"> Kirim Pesan Lain </button>
     </div>
    </div><!-- Footer -->
    <footer class="text-center mt-8 text-teal-100/70 text-sm">
     <p>¬© 2026 Kas Masjid - Data tersinkron dari Google Sheet</p>
     <p id="last-sync" class="text-xs mt-1">Terakhir diperbarui: -</p>
    </footer>
   </div>
  </div><!-- Toast Notification -->
  <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-xl shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
   <p id="toast-message">Berhasil!</p>
  </div>
  <script>
    // Google Apps Script Web App URL - dengan parameter action
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzkZE04KqraseX0pGSARSmdKxK_70QD85FgGJWSdmNO9JDnDI3WBnuyLyBLILVioxzZ/exec?action=getTransactions';
    
    const defaultConfig = {
      mosque_name: 'Kas Masjid',
      report_title: 'LAPORAN KAS MASJID JAMI\' DAARUL MUTTAQIN',
      feedback_email: 'akbar.romadon34@gmail.com',
      primary_action_color: '#0d9488'
    };

    let allData = [];
    let filteredData = [];
    let saldoAwal = 0;
    let currentSort = 'newest';
    let currentFilter = '';
    let currentPage = 1;
    const ITEMS_PER_PAGE = 20;

    function formatRupiah(amount) {
      if (amount === 0 || amount === null || amount === undefined) {
        return 'Rp 0';
      }
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      try {
        let date;
        // Handle Google Sheets date format
        if (typeof dateStr === 'string' && dateStr.includes('T')) {
          date = new Date(dateStr);
        } else if (typeof dateStr === 'string' && dateStr.includes('/')) {
          const parts = dateStr.split('/');
          if (parts.length === 3) {
            date = new Date(parts[2], parts[1] - 1, parts[0]);
          }
        } else if (typeof dateStr === 'string' && dateStr.includes('-')) {
          date = new Date(dateStr);
        } else {
          date = new Date(dateStr);
        }
        
        if (isNaN(date.getTime())) return dateStr;
        return date.toLocaleDateString('id-ID', {
          day: 'numeric',
          month: 'long',
          year: 'numeric'
        });
      } catch (e) {
        return dateStr;
      }
    }

    function parseDate(dateStr) {
      if (!dateStr) return null;
      try {
        let date;
        if (typeof dateStr === 'string' && dateStr.includes('/')) {
          const parts = dateStr.split('/');
          if (parts.length === 3) {
            date = new Date(parts[2], parts[1] - 1, parts[0]);
          }
        } else {
          date = new Date(dateStr);
        }
        return isNaN(date.getTime()) ? null : date;
      } catch (e) {
        return null;
      }
    }

    function getDateForFilter(dateStr) {
      const date = parseDate(dateStr);
      if (!date) return '';
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      return `${year}-${month}`;
    }

    function calculateTotals(data) {
      // Tipe dari Apps Script: 'MASUK' atau 'KELUAR' (uppercase)
      const income = data
        .filter(item => {
          const tipe = item.tipe ? item.tipe.toString().toUpperCase() : '';
          return tipe === 'MASUK' || tipe.includes('MASUK');
        })
        .reduce((sum, item) => sum + (parseFloat(item.jumlah) || 0), 0);
      
      const expense = data
        .filter(item => {
          const tipe = item.tipe ? item.tipe.toString().toUpperCase() : '';
          return tipe === 'KELUAR' || tipe.includes('KELUAR');
        })
        .reduce((sum, item) => sum + (parseFloat(item.jumlah) || 0), 0);
      
      const balance = saldoAwal + income - expense;
      
      return { income, expense, balance };
    }

    function updateSummary(data) {
      const { income, expense, balance } = calculateTotals(data);
      const hasData = data.length > 0 || saldoAwal > 0;
      
      document.getElementById('total-income').textContent = hasData ? formatRupiah(income) : '-';
      document.getElementById('total-expense').textContent = hasData ? formatRupiah(expense) : '-';
      document.getElementById('total-balance').textContent = hasData ? formatRupiah(balance) : '-';
    }

    function updateSyncStatus(status, isLoading = false) {
      const syncIcon = document.getElementById('sync-icon');
      const syncText = document.getElementById('sync-text');
      
      if (isLoading) {
        syncIcon.classList.add('animate-spin');
        syncIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>';
      } else {
        syncIcon.classList.remove('animate-spin');
        syncIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>';
      }
      
      syncText.textContent = status;
    }

    function showLoading() {
      document.getElementById('loading-state').classList.remove('hidden');
      document.getElementById('error-state').classList.add('hidden');
      document.getElementById('data-container').classList.add('hidden');
      document.getElementById('setup-instructions').classList.add('hidden');
      updateSyncStatus('Menghubungkan ke Google Sheet...', true);
    }

    function showError(message, debugInfo = '') {
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('error-state').classList.remove('hidden');
      document.getElementById('data-container').classList.add('hidden');
      document.getElementById('setup-instructions').classList.remove('hidden');
      document.getElementById('error-message').textContent = message;
      document.getElementById('debug-info').textContent = debugInfo;
      updateSyncStatus('Gagal terhubung', false);
    }

    function showData() {
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('error-state').classList.add('hidden');
      document.getElementById('setup-instructions').classList.add('hidden');
      document.getElementById('data-container').classList.remove('hidden');
      document.getElementById('data-container').classList.add('opacity-100');
      
      const now = new Date().toLocaleString('id-ID', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      document.getElementById('last-sync').textContent = `Terakhir diperbarui: ${now}`;
      updateSyncStatus('Tersinkron ‚úì', false);
    }

    // JSONP callback handler
    window.handleGoogleSheetData = function(result) {
      try {
        if (result.status === 'success' && result.data) {
          processData(result);
        } else if (result.error) {
          showError(result.error, JSON.stringify(result, null, 2));
        } else {
          processData(result);
        }
      } catch (error) {
        showError('Error processing data: ' + error.message, error.stack);
      }
    };

    function processData(result) {
      // Handle response dari Google Apps Script
      // Format: { ok: true, data: [...] } atau { ok: false, error: '...' }
      
      console.log('Processing result:', result);
      
      // Cek jika ada error dari Apps Script
      if (result.ok === false && result.error) {
        showError(result.error, JSON.stringify(result, null, 2));
        return;
      }
      
      let dataArray = [];
      
      // Format dari Apps Script Anda: { ok: true, data: [...] }
      if (result.ok === true && Array.isArray(result.data)) {
        dataArray = result.data;
      } else if (Array.isArray(result)) {
        dataArray = result;
      } else if (result.data && Array.isArray(result.data)) {
        dataArray = result.data;
      }
      
      // Map data dari format Apps Script Anda:
      // { tgl, tipe, kategori, keterangan, jumlah }
      allData = dataArray.map(row => ({
        tanggal: row.tgl || row.tanggal || row.Tanggal || '',
        tipe: row.tipe || row.Tipe || '',
        kategori: row.kategori || row.Kategori || '',
        keterangan: row.keterangan || row.Keterangan || '',
        jumlah: parseFloat(row.jumlah || row.Jumlah || 0)
      })).filter(item => item.tanggal || item.jumlah);
      
      // Hitung saldo awal dari data (tidak ada field saldoAwal)
      saldoAwal = parseFloat(result.saldoAwal || result.saldo_awal || 0);
      
      console.log('Processed data:', allData);
      console.log('Total records:', allData.length);
      
      filteredData = sortData([...allData], currentSort);
      updateSummary(filteredData);
      renderTable(filteredData);
      showData();
      showToast(`Data berhasil dimuat! (${allData.length} transaksi)`);
    }

    async function fetchDataFromGoogleSheet() {
      showLoading();
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000);
        
        // Fetch dengan redirect follow untuk handle Google redirect
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'GET',
          redirect: 'follow',
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const text = await response.text();
        
        // Debug: tampilkan response
        console.log('Response status:', response.status);
        console.log('Response text (first 500 chars):', text.substring(0, 500));
        
        let result;
        
        // Coba parse sebagai JSON
        try {
          result = JSON.parse(text);
          console.log('Parsed JSON:', result);
        } catch (parseError) {
          // Mungkin ada wrapper atau format lain
          // Coba extract JSON dari response
          const jsonMatch = text.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            try {
              result = JSON.parse(jsonMatch[0]);
              console.log('Extracted JSON:', result);
            } catch (e) {
              throw new Error('Tidak bisa parse JSON dari response');
            }
          } else {
            throw new Error('Response bukan JSON valid. Response: ' + text.substring(0, 300));
          }
        }
        
        processData(result);
        
      } catch (error) {
        console.error('Fetch error:', error);
        
        let errorMsg = 'Gagal menghubungi Google Sheet.';
        let debugInfo = `Error: ${error.message}\n`;
        debugInfo += `URL: ${GOOGLE_SCRIPT_URL}\n`;
        debugInfo += `Time: ${new Date().toISOString()}\n\n`;
        debugInfo += `Kemungkinan penyebab:\n`;
        debugInfo += `1. Google Apps Script belum di-deploy sebagai Web App\n`;
        debugInfo += `2. Akses belum diset ke "Anyone"\n`;
        debugInfo += `3. Ada error di kode Apps Script\n`;
        debugInfo += `4. CORS issue dari browser\n`;
        
        if (error.name === 'AbortError') {
          errorMsg = 'Koneksi timeout (20 detik). Server tidak merespons.';
        } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          errorMsg = 'CORS Error - Google Apps Script memblokir akses dari domain ini.';
          debugInfo += `\nSOLUSI CORS:\n`;
          debugInfo += `Pastikan Google Apps Script return dengan ContentService.createTextOutput().setMimeType(ContentService.MimeType.JSON)\n`;
        }
        
        showError(errorMsg, debugInfo);
      }
    }

    function getPaginatedData(data, page) {
      const startIndex = (page - 1) * ITEMS_PER_PAGE;
      const endIndex = startIndex + ITEMS_PER_PAGE;
      return data.slice(startIndex, endIndex);
    }

    function getTotalPages(data) {
      return Math.ceil(data.length / ITEMS_PER_PAGE);
    }

    function updatePagination(data) {
      const totalPages = getTotalPages(data);
      const totalItems = data.length;
      const startItem = totalItems === 0 ? 0 : (currentPage - 1) * ITEMS_PER_PAGE + 1;
      const endItem = Math.min(currentPage * ITEMS_PER_PAGE, totalItems);
      
      const paginationContainer = document.getElementById('pagination-container');
      const paginationInfo = document.getElementById('pagination-info');
      const pageNumbers = document.getElementById('page-numbers');
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      
      if (totalItems === 0) {
        paginationContainer.classList.add('hidden');
        return;
      }
      
      paginationContainer.classList.remove('hidden');
      paginationInfo.textContent = `Menampilkan ${startItem}-${endItem} dari ${totalItems} data`;
      
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;
      
      let pageNumbersHtml = '';
      
      if (totalPages <= 5) {
        for (let i = 1; i <= totalPages; i++) {
          pageNumbersHtml += createPageButton(i);
        }
      } else {
        pageNumbersHtml += createPageButton(1);
        
        if (currentPage > 3) {
          pageNumbersHtml += '<span class="px-2 text-gray-400">...</span>';
        }
        
        const startPage = Math.max(2, currentPage - 1);
        const endPage = Math.min(totalPages - 1, currentPage + 1);
        
        for (let i = startPage; i <= endPage; i++) {
          pageNumbersHtml += createPageButton(i);
        }
        
        if (currentPage < totalPages - 2) {
          pageNumbersHtml += '<span class="px-2 text-gray-400">...</span>';
        }
        
        pageNumbersHtml += createPageButton(totalPages);
      }
      
      pageNumbers.innerHTML = pageNumbersHtml;
      
      document.querySelectorAll('.page-btn').forEach(btn => {
        btn.onclick = function(e) {
          e.preventDefault();
          const pageNum = parseInt(this.getAttribute('data-page'));
          if (!isNaN(pageNum) && pageNum !== currentPage) {
            currentPage = pageNum;
            renderTable(filteredData);
            updatePagination(filteredData);
          }
        };
      });
    }

    function createPageButton(page) {
      const isActive = page === currentPage;
      const activeClass = isActive 
        ? 'bg-teal-600 text-white shadow-md shadow-teal-600/30 scale-110' 
        : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-gray-400';
      return `<button type="button" data-page="${page}" class="page-btn w-11 h-11 ${activeClass} font-bold rounded-xl transition-all text-base">${page}</button>`;
    }

    function renderTable(data) {
      const tbody = document.getElementById('table-body');
      const emptyState = document.getElementById('empty-state');
      
      if (data.length === 0) {
        tbody.innerHTML = '';
        emptyState.classList.remove('hidden');
        updatePagination(data);
        return;
      }
      
      emptyState.classList.add('hidden');
      
      const paginatedData = getPaginatedData(data, currentPage);
      
      tbody.innerHTML = paginatedData.map(item => {
        // Tipe dari Apps Script: 'MASUK' atau 'KELUAR' (uppercase)
        const tipeStr = item.tipe ? item.tipe.toString().toUpperCase() : '';
        const isMasuk = tipeStr === 'MASUK' || tipeStr.includes('MASUK');
        return `
          <tr class="table-row-hover transition-colors">
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="text-gray-800 font-medium">${formatDate(item.tanggal)}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex px-3 py-1 rounded-full text-xs font-semibold ${
                isMasuk ? 'income-badge' : 'expense-badge'
              }">
                ${isMasuk ? '‚Üë Masuk' : '‚Üì Keluar'}
              </span>
            </td>
            <td class="px-6 py-4">
              <div class="text-gray-600">${item.keterangan || '-'}</div>
              ${item.kategori ? `<div class="text-xs text-gray-400 mt-1">üìÅ ${item.kategori}</div>` : ''}
            </td>
            <td class="px-6 py-4 text-right whitespace-nowrap">
              <span class="font-semibold ${isMasuk ? 'text-green-600' : 'text-red-600'}">
                ${isMasuk ? '+' : '-'} ${formatRupiah(item.jumlah)}
              </span>
            </td>
          </tr>
        `;
      }).join('');
      
      updatePagination(data);
    }

    function sortData(data, sortType) {
      return [...data].sort((a, b) => {
        const dateA = parseDate(a.tanggal);
        const dateB = parseDate(b.tanggal);
        if (!dateA || !dateB) return 0;
        return sortType === 'newest' ? dateB - dateA : dateA - dateB;
      });
    }

    function filterByMonth(data, monthYear) {
      if (!monthYear) return data;
      
      return data.filter(item => {
        const itemMonthYear = getDateForFilter(item.tanggal);
        return itemMonthYear === monthYear;
      });
    }

    function updateFilterInfo() {
      const filterInfo = document.getElementById('filter-info');
      const monthFilter = document.getElementById('month-filter').value;
      
      if (monthFilter) {
        const [year, month] = monthFilter.split('-');
        const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                          'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        filterInfo.textContent = `Menampilkan data ${monthNames[parseInt(month) - 1]} ${year}`;
      } else {
        filterInfo.textContent = 'Menampilkan semua data';
      }
    }

    function applyFiltersAndSort() {
      const monthFilter = document.getElementById('month-filter').value;
      const sortSelect = document.getElementById('sort-select').value;
      
      currentFilter = monthFilter;
      currentSort = sortSelect;
      currentPage = 1;
      
      filteredData = filterByMonth(allData, monthFilter);
      filteredData = sortData(filteredData, sortSelect);
      
      updateSummary(filteredData);
      renderTable(filteredData);
      updateFilterInfo();
    }

    function resetFilters() {
      document.getElementById('month-filter').value = '';
      document.getElementById('sort-select').value = 'newest';
      
      currentFilter = '';
      currentSort = 'newest';
      currentPage = 1;
      
      filteredData = sortData([...allData], 'newest');
      
      updateSummary(filteredData);
      renderTable(filteredData);
      updateFilterInfo();
      
      showToast('Filter telah direset');
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      
      toastMessage.textContent = message;
      toast.classList.remove('translate-y-20', 'opacity-0');
      
      setTimeout(() => {
        toast.classList.add('translate-y-20', 'opacity-0');
      }, 3000);
    }

    function generatePDF() {
      if (filteredData.length === 0) {
        showToast('Tidak ada data untuk diunduh');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const config = window.elementSdk?.config || defaultConfig;
      const mosqueName = config.mosque_name || defaultConfig.mosque_name;
      const reportTitle = config.report_title || defaultConfig.report_title;
      
      const monthFilter = document.getElementById('month-filter').value;
      let periodText = 'Semua Periode';
      
      if (monthFilter) {
        const [year, month] = monthFilter.split('-');
        const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                          'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        periodText = `${monthNames[parseInt(month) - 1]} ${year}`;
      }
      
      const { income, expense, balance } = calculateTotals(filteredData);
      
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text(reportTitle, 105, 20, { align: 'center' });
      
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      doc.text(mosqueName, 105, 30, { align: 'center' });
      
      doc.setFontSize(10);
      doc.text(`Periode: ${periodText}`, 105, 38, { align: 'center' });
      doc.text('Data dari Google Sheet', 105, 44, { align: 'center' });
      
      doc.setDrawColor(13, 148, 136);
      doc.setLineWidth(0.5);
      doc.line(20, 48, 190, 48);
      
      doc.setFontSize(10);
      doc.text(`Saldo Awal: ${formatRupiah(saldoAwal)}`, 20, 56);
      
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.text('RINGKASAN KEUANGAN', 20, 66);
      
      doc.setFont(undefined, 'normal');
      doc.setFontSize(10);
      
      doc.setFillColor(240, 253, 244);
      doc.rect(20, 70, 55, 22, 'F');
      doc.setFillColor(254, 226, 226);
      doc.rect(80, 70, 55, 22, 'F');
      doc.setFillColor(240, 253, 250);
      doc.rect(140, 70, 50, 22, 'F');
      
      doc.setTextColor(22, 101, 52);
      doc.text('Total Pemasukan', 25, 79);
      doc.setFont(undefined, 'bold');
      doc.text(formatRupiah(income), 25, 87);
      
      doc.setTextColor(153, 27, 27);
      doc.setFont(undefined, 'normal');
      doc.text('Total Pengeluaran', 85, 79);
      doc.setFont(undefined, 'bold');
      doc.text(formatRupiah(expense), 85, 87);
      
      doc.setTextColor(13, 148, 136);
      doc.setFont(undefined, 'normal');
      doc.text('Total Saldo', 145, 79);
      doc.setFont(undefined, 'bold');
      doc.text(formatRupiah(balance), 145, 87);
      
      doc.setTextColor(0, 0, 0);
      
      const tableData = filteredData.map(item => {
        const tipeStr = item.tipe ? item.tipe.toString().toUpperCase() : '';
        const isMasuk = tipeStr === 'MASUK' || tipeStr.includes('MASUK');
        const keteranganFull = item.kategori 
          ? `${item.keterangan || '-'} (${item.kategori})`
          : (item.keterangan || '-');
        return [
          formatDate(item.tanggal),
          isMasuk ? 'Masuk' : 'Keluar',
          keteranganFull,
          (isMasuk ? '+' : '-') + ' ' + formatRupiah(item.jumlah)
        ];
      });
      
      doc.autoTable({
        startY: 98,
        head: [['Tanggal', 'Tipe', 'Keterangan', 'Jumlah']],
        body: tableData,
        theme: 'grid',
        headStyles: {
          fillColor: [13, 148, 136],
          textColor: [255, 255, 255],
          fontStyle: 'bold'
        },
        alternateRowStyles: {
          fillColor: [249, 250, 251]
        },
        columnStyles: {
          0: { cellWidth: 35 },
          1: { cellWidth: 22 },
          2: { cellWidth: 80 },
          3: { cellWidth: 38, halign: 'right' }
        },
        styles: {
          fontSize: 8,
          cellPadding: 3
        }
      });
      
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(
          `Dicetak pada: ${new Date().toLocaleDateString('id-ID', { 
            day: 'numeric', 
            month: 'long', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          })}`,
          20,
          doc.internal.pageSize.height - 10
        );
        doc.text(
          `Halaman ${i} dari ${pageCount}`,
          190,
          doc.internal.pageSize.height - 10,
          { align: 'right' }
        );
      }
      
      const fileName = `Laporan-Kas-Masjid-${periodText.replace(/\s/g, '-')}.pdf`;
      doc.save(fileName);
      
      showToast('Laporan PDF berhasil diunduh!');
    }

    function applyConfig(config) {
      const mosqueName = config.mosque_name || defaultConfig.mosque_name;
      const reportTitle = config.report_title || defaultConfig.report_title;
      document.getElementById('mosque-name').textContent = mosqueName;
      document.getElementById('report-title-display').textContent = reportTitle;
    }

    // Event Listeners
    document.getElementById('month-filter').addEventListener('change', applyFiltersAndSort);
    document.getElementById('sort-select').addEventListener('change', applyFiltersAndSort);
    document.getElementById('reset-btn').addEventListener('click', resetFilters);
    document.getElementById('download-btn').addEventListener('click', generatePDF);
    document.getElementById('refresh-btn').addEventListener('click', fetchDataFromGoogleSheet);
    document.getElementById('retry-btn').addEventListener('click', fetchDataFromGoogleSheet);
    
    document.getElementById('prev-btn').addEventListener('click', function(e) {
      e.preventDefault();
      if (currentPage > 1) {
        currentPage--;
        renderTable(filteredData);
        updatePagination(filteredData);
      }
    });
    
    document.getElementById('next-btn').addEventListener('click', function(e) {
      e.preventDefault();
      const totalPages = getTotalPages(filteredData);
      if (currentPage < totalPages) {
        currentPage++;
        renderTable(filteredData);
        updatePagination(filteredData);
      }
    });

    // Feedback Form Handler
    const feedbackForm = document.getElementById('feedback-form');
    const feedbackSuccess = document.getElementById('feedback-success');
    const sendAnotherBtn = document.getElementById('send-another-btn');
    
    feedbackForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const category = document.getElementById('feedback-category').value;
      const message = document.getElementById('feedback-message').value;
      
      if (!category || !message.trim()) {
        showToast('Mohon lengkapi semua field');
        return;
      }
      
      const config = window.elementSdk?.config || defaultConfig;
      const mosqueName = config.mosque_name || defaultConfig.mosque_name;
      const feedbackEmail = config.feedback_email || defaultConfig.feedback_email;
      const emailSubject = encodeURIComponent(`[Kritik & Saran - ${category}] ${mosqueName}`);
      const emailBody = encodeURIComponent(
        `KRITIK & SARAN ANONIM\n` +
        `========================\n\n` +
        `Kategori: ${category}\n\n` +
        `Pesan:\n${message}\n\n` +
        `========================\n` +
        `Dikirim melalui: Sistem Kas Masjid\n` +
        `Tanggal: ${new Date().toLocaleDateString('id-ID', { 
          day: 'numeric', 
          month: 'long', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        })}`
      );
      
      const mailtoLink = `mailto:${feedbackEmail}?subject=${emailSubject}&body=${emailBody}`;
      window.open(mailtoLink, '_blank');
      
      feedbackForm.classList.add('hidden');
      feedbackSuccess.classList.remove('hidden');
      
      feedbackForm.reset();
      
      showToast('Membuka aplikasi email...');
    });
    
    sendAnotherBtn.addEventListener('click', function() {
      feedbackSuccess.classList.add('hidden');
      feedbackForm.classList.remove('hidden');
    });

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig: defaultConfig,
        onConfigChange: async (config) => {
          applyConfig(config);
        },
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.primary_action_color || defaultConfig.primary_action_color,
              set: (value) => {
                config.primary_action_color = value;
                window.elementSdk.setConfig({ primary_action_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['mosque_name', config.mosque_name || defaultConfig.mosque_name],
          ['report_title', config.report_title || defaultConfig.report_title],
          ['feedback_email', config.feedback_email || defaultConfig.feedback_email]
        ])
      });
    }

    // Initialize - fetch data from Google Sheet
    applyConfig(defaultConfig);
    fetchDataFromGoogleSheet();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b70313ab741d47b',t:'MTc2NzI1MTM3OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
